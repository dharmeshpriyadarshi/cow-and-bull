<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ka re? - Multi-Game Battle Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-900 min-h-screen">
    
    <div id="app" class="min-h-screen p-4 md:p-8">
        
        <!-- LANDING SCREEN -->
        <div id="landing-screen" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 fade-in border-2 border-gray-700">
                <h1 class="text-5xl font-black text-center bg-gradient-to-r from-blue-400 to-purple-500 bg-clip-text text-transparent mb-2">Ka re?</h1>
                <p class="text-center text-gray-300 mb-8 text-lg">Multi-Game Battle Platform</p>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-300 mb-2">Your Name</label>
                    <input type="text" id="username-input" maxlength="20" class="w-full p-3 bg-gray-700 border-2 border-gray-600 rounded-lg text-white placeholder-gray-400 focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition" placeholder="Enter your name...">
                </div>
                
                <div class="space-y-3">
                    <button onclick="goToRoomSelect()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        üéÆ Play a Game
                    </button>
                    <button onclick="startWar()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        ‚öîÔ∏è Declare a War
                    </button>
                </div>
            </div>
        </div>

        <!-- ROOM SELECTION SCREEN -->
        <div id="room-screen" class="hidden min-h-screen flex items-center justify-center">
            <div class="w-full max-w-2xl bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 fade-in border-2 border-gray-700">
                <button onclick="goBack()" class="mb-6 text-blue-400 hover:text-blue-300 font-semibold">‚Üê Back</button>
                <h2 class="text-3xl font-bold text-white mb-6">Room Selection</h2>
                
                <div class="mb-6">
                    <p class="text-gray-300 mb-3 font-semibold">Hello, <span id="room-username" class="text-blue-400"></span>!</p>
                </div>

                <div class="bg-gradient-to-r from-green-900/30 to-blue-900/30 p-6 rounded-lg mb-6 border-2 border-green-600/50">
                    <h3 class="text-xl font-bold text-white mb-3">Create New Room</h3>
                    <button onclick="createRoom()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        ‚ú® Create Room
                    </button>
                </div>

                <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 p-6 rounded-lg border-2 border-blue-600/50">
                    <h3 class="text-xl font-bold text-white mb-3">Join Existing Room</h3>
                    <input type="text" id="room-code-input" maxlength="6" class="w-full p-3 bg-gray-700 border-2 border-gray-600 text-white rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition mb-3 text-center tracking-widest text-lg" placeholder="e.g. ABC123">
                    <button onclick="joinRoom()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        üîó Join Room
                    </button>
                    <p id="join-message" class="text-red-500 text-sm mt-2 h-5"></p>
                </div>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="hidden min-h-screen p-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-6 mb-6 fade-in border-2 border-gray-700">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-white">Game Lobby</h2>
                            <p class="text-gray-300">Room: <span id="lobby-room-id" class="font-mono font-bold text-blue-400 text-lg"></span></p>
                        </div>
                        <button onclick="exitRoom()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            Exit Room
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-900/40 p-4 rounded-lg border-2 border-blue-500/50">
                            <p class="text-sm text-gray-400">Your Name</p>
                            <p class="text-xl font-bold text-blue-400" id="lobby-your-name"></p>
                        </div>
                        <div class="bg-orange-900/40 p-4 rounded-lg border-2 border-orange-500/50">
                            <p class="text-sm text-gray-400">Opponent</p>
                            <p class="text-xl font-bold text-orange-400" id="lobby-opponent-name">Waiting...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-6 fade-in border-2 border-gray-700">
                    <h3 class="text-2xl font-bold text-white mb-4">Select a Game</h3>
                    
                    <div class="mb-6">
                        <button onclick="startWarFromLobby()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-4 rounded-lg transition shadow-lg transform hover:scale-105">
                            ‚öîÔ∏è DECLARE A WAR
                        </button>
                        <p class="text-center text-gray-400 text-sm mt-2">Challenge your opponent to all 5 games!</p>
                    </div>
                    
                    <div class="border-t border-gray-700 pt-6 mb-4">
                        <p class="text-gray-400 text-center text-sm mb-3">Or play a single game:</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onclick="selectGame('codebreaker')" class="p-6 bg-gradient-to-br from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            üîê Code Breaker
                        </button>
                        <button onclick="selectGame('tictactoe')" class="p-6 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            ‚≠ï Tic Tac Toe
                        </button>
                        <button onclick="selectGame('wavelength')" class="p-6 bg-gradient-to-br from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            üìä Wavelength
                        </button>
                        <button onclick="selectGame('stonepaper')" class="p-6 bg-gradient-to-br from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            ‚úã Stone Paper
                        </button>
                        <button onclick="selectGame('fastfour')" class="p-6 bg-gradient-to-br from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            üéØ Fast Four
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- WAR SELECTION SCREEN -->
        <div id="war-screen" class="hidden min-h-screen flex items-center justify-center">
            <div class="w-full max-w-md bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 fade-in border-2 border-red-600/50">
                <button onclick="warGoBack()" class="mb-4 text-blue-400 hover:text-blue-300 font-semibold">‚Üê Back</button>
                <h2 class="text-4xl font-black text-center bg-gradient-to-r from-red-400 to-orange-500 bg-clip-text text-transparent mb-2">‚öîÔ∏è DECLARE A WAR</h2>
                <p class="text-center text-gray-300 mb-8">Challenge another player to battle through all 5 games!</p>
                
                <div class="bg-red-900/30 p-6 rounded-lg mb-6 border-2 border-red-600/50">
                    <h3 class="text-lg font-bold text-white mb-3">Create New War</h3>
                    <button onclick="confirmWar()" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        ‚öîÔ∏è Create War Room
                    </button>
                </div>

                <div class="bg-blue-900/30 p-6 rounded-lg border-2 border-blue-600/50">
                    <h3 class="text-lg font-bold text-white mb-3">Join Existing War</h3>
                    <input type="text" id="war-code-join" maxlength="6" class="w-full p-3 bg-gray-700 border-2 border-gray-600 text-white rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-500/50 transition mb-3 text-center tracking-widest text-lg" placeholder="e.g. ABC123">
                    <button onclick="warJoinConfirm()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        üîó Join War
                    </button>
                    <p id="war-join-message" class="text-red-500 text-sm mt-2 h-5"></p>
                </div>
            </div>
        </div>

        <!-- WAR LOBBY SCREEN -->
        <div id="war-lobby-screen" class="hidden min-h-screen flex items-center justify-center">
            <div class="w-full max-w-md bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-8 fade-in border-2 border-red-600/50">
                <button onclick="exitWarLobby()" class="mb-4 text-blue-400 hover:text-blue-300 font-semibold">‚Üê Back</button>
                <h2 class="text-3xl font-bold text-center bg-gradient-to-r from-red-400 to-orange-500 bg-clip-text text-transparent mb-6">‚öîÔ∏è WAR LOBBY</h2>
                
                <div class="bg-gradient-to-r from-purple-900/40 to-red-900/40 p-6 rounded-lg mb-6 border-2 border-red-500/50">
                    <p class="text-sm text-gray-400 mb-2">War Code</p>
                    <p class="text-2xl font-black text-red-400 text-center tracking-widest mb-4" id="war-code-display"></p>
                    <p class="text-center text-gray-300 font-semibold">Share this code with your opponent!</p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-900/40 p-4 rounded-lg border-2 border-blue-500/50">
                        <p class="text-sm text-gray-400">You</p>
                        <p class="text-lg font-bold text-blue-400" id="war-your-name"></p>
                    </div>
                    <div class="bg-orange-900/40 p-4 rounded-lg border-2 border-orange-500/50">
                        <p class="text-sm text-gray-400">Opponent</p>
                        <p class="text-lg font-bold text-orange-400" id="war-opponent-name">Waiting...</p>
                    </div>
                </div>

                <div id="war-waiting-message" class="text-center text-gray-400 mb-4">
                    <p class="text-sm">Waiting for opponent to join...</p>
                </div>

                <button id="war-start-button" onclick="startWarGames()" disabled class="w-full bg-red-500 hover:bg-red-600 disabled:bg-gray-300 text-white font-bold py-3 rounded-lg transition shadow-lg">
                    ‚öîÔ∏è START WAR
                </button>
            </div>
        </div>

        <!-- WAR GAME SCREEN -->
        <div id="war-game-screen" class="hidden min-h-screen bg-gray-900 p-4">
            <div class="max-w-4xl mx-auto">
                <div class="bg-gradient-to-br from-gray-800 to-gray-900 rounded-2xl shadow-2xl p-4 mb-4 border-2 border-gray-700">
                    <button onclick="exitWarGame()" class="mb-3 text-blue-400 hover:text-blue-300 font-semibold text-sm">‚Üê Exit War</button>
                    <div class="mb-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 id="war-game-title" class="text-2xl font-bold text-white"></h2>
                            <span id="war-game-number" class="text-sm font-semibold text-gray-400"></span>
                        </div>
                        <div id="war-game-progress" class="flex gap-1"></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="bg-blue-900/40 p-2 rounded-lg border border-blue-500/50">
                            <p class="text-xs text-gray-400">Player 1</p>
                            <p class="text-lg font-bold text-blue-400" id="war-p1-name"></p>
                            <p class="text-xl font-black text-blue-300" id="war-p1-score">0</p>
                        </div>
                        <div class="bg-orange-900/40 p-2 rounded-lg border border-orange-500/50">
                            <p class="text-xs text-gray-400">Player 2</p>
                            <p class="text-lg font-bold text-orange-400" id="war-p2-name"></p>
                            <p class="text-xl font-black text-orange-300" id="war-p2-score">0</p>
                        </div>
                    </div>
                </div>
                
                <div id="game-container-war"></div>
            </div>
        </div>

        <!-- GAME CONTAINER -->
        <div id="game-container" class="hidden"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, updateDoc, arrayUnion, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAydXymmuO9r9xFC5S8b-eMI-dLnbrcP1w",
            authDomain: "code-breaker-duel.firebaseapp.com",
            projectId: "code-breaker-duel",
            storageBucket: "code-breaker-duel.appspot.com",
            messagingSenderId: "165393867049",
            appId: "1:165393867049:web:2d50c1c9073a38d4b28038",
            measurementId: "G-NDKVEEE4YR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.appState = {
            username: '',
            userId: 'user_' + Math.random().toString(36).substr(2, 9),
            roomId: null,
            playerNumber: null,
            currentGame: null
        };

        window.goBack = function() {
            document.getElementById('landing-screen').classList.remove('hidden');
            document.getElementById('room-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.add('hidden');
        };

        window.goToRoomSelect = function() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert('Please enter your name');
                return;
            }
            window.appState.username = username;
            document.getElementById('room-username').textContent = username;
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('room-screen').classList.remove('hidden');
        };

        window.createRoom = async function() {
            const roomId = 'R' + Math.random().toString(36).substr(2, 5).toUpperCase();
            window.appState.roomId = roomId;
            window.appState.playerNumber = 'p1';
            
            const roomRef = doc(db, 'rooms', roomId);
            await setDoc(roomRef, {
                id: roomId,
                p1_id: window.appState.userId,
                p1_name: window.appState.username,
                p2_id: null,
                p2_name: null,
                status: 'waiting',
                createdAt: Date.now()
            });

            enterLobby();
        };

        window.joinRoom = async function() {
            const roomCode = document.getElementById('room-code-input').value.toUpperCase();
            if (!roomCode || roomCode.length !== 6) {
                document.getElementById('join-message').textContent = 'Invalid room code';
                return;
            }

            try {
                const roomSnap = await getDocs(query(collection(db, 'rooms'), where('id', '==', roomCode)));
                
                if (roomSnap.empty) {
                    document.getElementById('join-message').textContent = 'Room not found';
                    return;
                }

                const room = roomSnap.docs[0].data();
                const roomRef = roomSnap.docs[0].ref;
                
                if (room.p1_id === window.appState.userId) {
                    window.appState.playerNumber = 'p1';
                } else if (room.p2_id === window.appState.userId) {
                    window.appState.playerNumber = 'p2';
                } else if (room.p2_id === null) {
                    window.appState.playerNumber = 'p2';
                    await updateDoc(roomRef, {
                        p2_id: window.appState.userId,
                        p2_name: window.appState.username,
                        status: 'active'
                    });
                } else {
                    document.getElementById('join-message').textContent = 'Room is full';
                    return;
                }

                window.appState.roomId = roomCode;
                enterLobby();
            } catch (error) {
                console.error('Error joining room:', error);
                document.getElementById('join-message').textContent = 'Error joining room';
            }
        };

        window.enterLobby = function() {
            document.getElementById('room-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-room-id').textContent = window.appState.roomId;
            document.getElementById('lobby-your-name').textContent = window.appState.username;
            
            listenToRoom();
        };

        window.listenToRoom = function() {
            const roomRef = doc(db, 'rooms', window.appState.roomId);
            onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    const room = doc.data();
                    const opponentName = window.appState.playerNumber === 'p1' ? room.p2_name : room.p1_name;
                    document.getElementById('lobby-opponent-name').textContent = opponentName || 'Waiting...';
                    
                    // Check for game request
                    if (room.gameRequest && room.gameRequest.requestedBy !== window.appState.playerNumber) {
                        showGameRequest(room.gameRequest);
                    }
                    
                    // Check if game was accepted
                    if (room.gameRequest && room.gameRequest.status === 'accepted' && !window.appState.gameStarted) {
                        window.appState.gameStarted = true;
                        startAcceptedGame(room.gameRequest.gameType);
                    }
                }
            });
        };

        window.selectGame = async function(gameType) {
            if (!window.appState.roomId) {
                alert('You need to be in a room first!');
                return;
            }
            
            // Check if both players are in the room
            const roomRef = doc(db, 'rooms', window.appState.roomId);
            const roomSnap = await getDoc(roomRef);
            
            if (!roomSnap.exists()) {
                alert('Room not found!');
                return;
            }
            
            const roomData = roomSnap.data();
            if (!roomData.p1_id || !roomData.p2_id) {
                alert('Waiting for opponent to join the room!');
                return;
            }
            
            // Send game request
            const gameNames = {
                'codebreaker': 'üîê Code Breaker',
                'tictactoe': '‚ö≠ Tic Tac Toe',
                'wavelength': 'üìä Wavelength',
                'stonepaper': '‚úã Stone Paper Scissor',
                'fastfour': 'üéØ Fast Four'
            };
            
            try {
                await updateDoc(roomRef, {
                    gameRequest: {
                        gameType: gameType,
                        gameName: gameNames[gameType],
                        requestedBy: window.appState.playerNumber,
                        status: 'pending',
                        timestamp: new Date().toISOString()
                    }
                });
                
                showWaitingForResponse(gameNames[gameType]);
            } catch (error) {
                console.error('Error sending game request:', error);
                alert('Failed to send game request. Please try again.');
            }
        };

        window.exitRoom = async function() {
            if (confirm('Are you sure you want to exit this room?')) {
                try {
                    const roomRef = doc(db, 'rooms', window.appState.roomId);
                    await deleteDoc(roomRef);
                    window.appState.roomId = null;
                    window.appState.playerNumber = null;
                    window.appState.gameStarted = false;
                    document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
                    document.getElementById('lobby-screen').classList.add('hidden');
                    document.getElementById('game-container').classList.add('hidden');
                    document.getElementById('landing-screen').classList.remove('hidden');
                } catch (error) {
                    console.error('Error exiting room:', error);
                }
            }
        };

        window.showGameRequest = function(request) {
            // Remove any existing request modals
            document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            
            if (request.status !== 'pending') return;
            
            const modal = document.createElement('div');
            modal.className = 'game-request-modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `<div class="bg-gradient-to-br from-gray-800 to-gray-900 border-2 border-blue-500/50 rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-2xl font-bold mb-4 text-blue-400">Game Request</h3>
                <p class="text-gray-300 mb-6">Your opponent wants to play:<br><span class="text-xl font-bold text-white">${request.gameName}</span></p>
                <div class="flex gap-4 justify-center">
                    <button onclick="acceptGameRequest()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg transform hover:scale-105">
                        ‚úî Accept
                    </button>
                    <button onclick="rejectGameRequest()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg transition shadow-lg transform hover:scale-105">
                        ‚úñ Reject
                    </button>
                </div>
            </div>`;
            document.body.appendChild(modal);
        };

        window.showWaitingForResponse = function(gameName) {
            document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            
            const modal = document.createElement('div');
            modal.className = 'game-request-modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `<div class="bg-gradient-to-br from-gray-800 to-gray-900 border-2 border-yellow-500/50 rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-2xl font-bold mb-4 text-yellow-400">Waiting for Response...</h3>
                <p class="text-gray-300 mb-6">You requested to play:<br><span class="text-xl font-bold text-white">${gameName}</span></p>
                <div class="animate-pulse text-gray-400 mb-4">
                    <p>Waiting for opponent's response...</p>
                </div>
                <button onclick="cancelGameRequest()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg transition">
                    Cancel Request
                </button>
            </div>`;
            document.body.appendChild(modal);
        };

        window.acceptGameRequest = async function() {
            try {
                const roomRef = doc(db, 'rooms', window.appState.roomId);
                await updateDoc(roomRef, {
                    'gameRequest.status': 'accepted'
                });
                document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            } catch (error) {
                console.error('Error accepting game request:', error);
            }
        };

        window.rejectGameRequest = async function() {
            try {
                const roomRef = doc(db, 'rooms', window.appState.roomId);
                await updateDoc(roomRef, {
                    gameRequest: null
                });
                document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            } catch (error) {
                console.error('Error rejecting game request:', error);
            }
        };

        window.cancelGameRequest = async function() {
            try {
                const roomRef = doc(db, 'rooms', window.appState.roomId);
                await updateDoc(roomRef, {
                    gameRequest: null
                });
                document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            } catch (error) {
                console.error('Error cancelling game request:', error);
            }
        };

        window.startAcceptedGame = function(gameType) {
            document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            window.appState.currentGame = gameType;
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            loadGame(gameType);
        };

        window.backToLobby = async function() {
            window.appState.gameStarted = false;
            
            // Clear game request when returning to lobby
            try {
                const roomRef = doc(db, 'rooms', window.appState.roomId);
                await updateDoc(roomRef, {
                    gameRequest: null
                });
            } catch (error) {
                console.error('Error clearing game request:', error);
            }
            
            document.querySelectorAll('.game-request-modal').forEach(el => el.remove());
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
        };

        window.loadGame = function(gameType) {
            const isWarMode = gameType.includes('_war');
            const actualGameType = gameType.replace('_war', '');
            
            // Set global container for game rendering
            window.gameContainerElement = isWarMode ? 'game-container-war' : 'game-container';
            
            switch(actualGameType) {
                case 'codebreaker':
                    loadCodeBreakerGame();
                    break;
                case 'tictactoe':
                    loadTicTacToeGame();
                    break;
                case 'wavelength':
                    loadWavelengthGame();
                    break;
                case 'stonepaper':
                    loadStonePaperGame();
                    break;
                case 'fastfour':
                    loadFastFourGame();
                    break;
            }
        };

        // ==================== CODE BREAKER GAME ====================
        window.loadCodeBreakerGame = function() {
            const containerId = window.gameContainerElement || 'game-container';
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-indigo-600">üîê Code Breaker</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="cb-status" class="bg-indigo-100 text-indigo-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading...</div>

                    <div id="cb-setup" class="mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Enter Your Secret 4-Digit Code</h3>
                        <div class="flex gap-3 mb-4">
                            <input type="text" id="cb-code-input" maxlength="4" class="flex-grow p-3 border-2 border-gray-300 rounded-lg text-3xl tracking-widest text-center font-mono focus:border-indigo-500" placeholder="1234">
                            <button onclick="cbSetCode()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Lock In</button>
                        </div>
                        <p id="cb-message" class="text-red-500 h-5"></p>
                    </div>

                    <div id="cb-gameplay" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-indigo-50 p-6 rounded-lg border-2 border-indigo-300">
                                <h4 class="font-bold text-lg mb-4">Make Your Guess</h4>
                                <div class="flex gap-3 mb-4">
                                    <input type="text" id="cb-guess" maxlength="4" class="flex-grow p-3 border-2 border-gray-300 rounded-lg text-2xl tracking-widest text-center font-mono">
                                    <button onclick="cbSubmitGuess()" id="cb-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50" disabled>Submit</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-4">History</h4>
                                <div class="max-h-80 overflow-y-auto bg-gray-50 rounded-lg p-4">
                                    <table class="w-full text-sm"><tbody id="cb-history"></tbody></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            window.cbState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                secret: null,
                maxTurns: 10,
                myGuesses: [],
                oppGuesses: [],
                myTurns: 0,
                oppTurns: 0,
                gameEnded: false
            };

            cbInitialize();
        };

        window.cbInitialize = async function() {
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'cbgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    p1_secret: null,
                    p2_secret: null,
                    p1_guesses: [],
                    p2_guesses: [],
                    turn: 'p1',
                    status: 'setup',
                    createdAt: Date.now()
                });
            }
            
            cbListen();
        };

        window.cbListen = function() {
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                const opp = window.cbState.playerNum === 'p1' ? 'p2' : 'p1';
                
                if (!game[`${window.cbState.playerNum}_secret`]) {
                    document.getElementById('cb-setup').classList.remove('hidden');
                    document.getElementById('cb-gameplay').classList.add('hidden');
                    document.getElementById('cb-status').textContent = 'Enter your secret code';
                    return;
                }
                
                if (!game[`${opp}_secret`]) {
                    document.getElementById('cb-status').textContent = 'Waiting for opponent...';
                    return;
                }
                
                document.getElementById('cb-setup').classList.add('hidden');
                document.getElementById('cb-gameplay').classList.remove('hidden');
                
                window.cbState.myGuesses = game[`${window.cbState.playerNum}_guesses`] || [];
                window.cbState.oppGuesses = game[`${opp}_guesses`] || [];
                window.cbState.myTurns = window.cbState.myGuesses.length;
                window.cbState.oppTurns = window.cbState.oppGuesses.length;
                
                const isMyTurn = game.turn === window.cbState.playerNum;
                document.getElementById('cb-btn').disabled = !isMyTurn;
                document.getElementById('cb-status').textContent = isMyTurn ? `Your Turn (${window.cbState.myTurns}/${window.cbState.maxTurns})` : `Opponent's Turn (${window.cbState.oppTurns}/${window.cbState.maxTurns})`;
                
                cbRenderHistory();
                
                if (game.status && (game.status.includes('_won') || game.status === 'draw')) {
                    cbShowEnd(game, game[`${opp}_secret`]);
                }
            });
        };

        window.cbSetCode = async function() {
            const code = document.getElementById('cb-code-input').value;
            if (code.length !== 4 || !/^\d{4}$/.test(code) || new Set(code).size !== 4) {
                document.getElementById('cb-message').textContent = 'Must be 4 unique digits';
                return;
            }
            
            window.cbState.secret = code;
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            const update = {};
            update[`${window.cbState.playerNum}_secret`] = code;
            await updateDoc(gameRef, update);
            
            document.getElementById('cb-code-input').disabled = true;
        };

        window.cbSubmitGuess = async function() {
            const guess = document.getElementById('cb-guess').value;
            if (guess.length !== 4 || !/^\d{4}$/.test(guess) || new Set(guess).size !== 4) return;
            if (window.cbState.myTurns >= window.cbState.maxTurns) return;
            
            const gameSnap = await getDocs(query(collection(db, 'cbgames'), where('roomId', '==', window.appState.roomId)));
            const game = gameSnap.docs[0].data();
            const opp = window.cbState.playerNum === 'p1' ? 'p2' : 'p1';
            const oppSecret = game[`${opp}_secret`];
            
            const {bulls, cows} = cbCalcFeedback(guess, oppSecret);
            const newGuess = {guess, bulls, cows, timestamp: Date.now()};
            
            let status = 'active';
            if (bulls === 4) status = `${window.cbState.playerNum}_won`;
            else if (window.cbState.myTurns + 1 >= window.cbState.maxTurns && window.cbState.oppTurns >= window.cbState.maxTurns) {
                const oppWon = game[`${opp}_guesses`].some(g => g.bulls === 4);
                if (!oppWon) status = 'draw';
            }
            
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            await updateDoc(gameRef, {
                [`${window.cbState.playerNum}_guesses`]: arrayUnion(newGuess),
                turn: opp,
                status: status
            });
            
            document.getElementById('cb-guess').value = '';
            document.getElementById('cb-btn').disabled = true;
        };

        window.cbCalcFeedback = function(guess, secret) {
            let bulls = 0, cows = 0;
            const sa = secret.split('');
            const ga = guess.split('');
            
            for (let i = 0; i < 4; i++) {
                if (ga[i] === sa[i]) { bulls++; sa[i] = null; ga[i] = null; }
            }
            for (let i = 0; i < 4; i++) {
                if (ga[i] !== null && sa.includes(ga[i])) { cows++; sa[sa.indexOf(ga[i])] = null; }
            }
            return {bulls, cows};
        };

        window.cbRenderHistory = function() {
            const hist = document.getElementById('cb-history');
            hist.innerHTML = window.cbState.myGuesses.map((g, i) => 
                `<tr class="border-t"><td class="p-2">${i+1}</td><td class="p-2 font-mono font-bold">${g.guess}</td><td class="p-2 text-center text-green-600 font-bold">${g.bulls}</td><td class="p-2 text-center text-yellow-600 font-bold">${g.cows}</td></tr>`
            ).join('');
        };

        window.cbShowEnd = function(game, oppSecret) {
            if (window.cbState.gameEnded) return;
            window.cbState.gameEnded = true;
            
            // Check if in war mode
            const isWarMode = window.appState.currentGame && window.appState.currentGame.includes('_war');
            
            let result = '';
            if (game.status === `${window.cbState.playerNum}_won`) {
                result = 'win';
            } else if (game.status === 'draw') {
                result = 'draw';
            } else {
                result = 'lose';
            }
            
            if (isWarMode) {
                warGameEnd(result);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            let title = '', color = '';
            
            if (game.status === `${window.cbState.playerNum}_won`) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
            } else if (game.status === 'draw') {
                title = 'ü§ù DRAW!';
                color = 'text-yellow-600';
            } else {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-4">Opponent's code: <span class="font-mono font-bold">${oppSecret}</span></p>
                <button onclick="backToLobby()" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        // ==================== TIC TAC TOE GAME ====================
        window.loadTicTacToeGame = function() {
            const containerId = window.gameContainerElement || 'game-container';
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-green-600">‚≠ï Tic Tac Toe</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="ttt-status" class="bg-green-100 text-green-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading...</div>

                    <!-- Round Info -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg text-center border-2 border-blue-300">
                            <p class="text-sm text-gray-600">Round</p>
                            <p class="text-2xl font-bold text-blue-600" id="ttt-round">1/3</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center border-2 border-purple-300">
                            <p class="text-sm text-gray-600">Your Wins</p>
                            <p class="text-2xl font-bold text-purple-600" id="ttt-your-wins">0</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center border-2 border-orange-300">
                            <p class="text-sm text-gray-600">Opponent Wins</p>
                            <p class="text-2xl font-bold text-orange-600" id="ttt-opp-wins">0</p>
                        </div>
                    </div>

                    <!-- Board -->
                    <div class="mb-6">
                        <div class="grid grid-cols-3 gap-2 bg-gray-800 p-2 rounded-lg" id="ttt-board">
                            ${Array(9).fill(0).map((_, i) => 
                                `<button onclick="tttMakeMove(${i})" id="ttt-cell-${i}" class="w-20 h-20 bg-white text-3xl font-bold rounded hover:bg-gray-100 transition text-center"></button>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Current Player -->
                    <div id="ttt-current" class="text-center text-lg font-semibold text-gray-700 mb-4">Waiting for game start...</div>
                </div>
            `;

            window.tttState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                playerSymbol: window.appState.playerNumber === 'p1' ? 'X' : 'O',
                currentRound: 1,
                maxRounds: 3,
                yourWins: 0,
                oppWins: 0,
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'p1',
                gameEnded: false,
                roundEnded: false,
                gameOverall: false
            };

            tttInitialize();
        };

        window.tttInitialize = async function() {
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'tttgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    board: ['', '', '', '', '', '', '', '', ''],
                    currentPlayer: 'p1',
                    round: 1,
                    p1_wins: 0,
                    p2_wins: 0,
                    status: 'active',
                    createdAt: Date.now()
                });
            }
            
            tttListen();
        };

        window.tttListen = function() {
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                
                window.tttState.board = game.board;
                window.tttState.currentRound = game.round || 1;
                window.tttState.yourWins = window.tttState.playerNum === 'p1' ? (game.p1_wins || 0) : (game.p2_wins || 0);
                window.tttState.oppWins = window.tttState.playerNum === 'p1' ? (game.p2_wins || 0) : (game.p1_wins || 0);
                window.tttState.currentPlayer = game.currentPlayer;
                
                document.getElementById('ttt-round').textContent = `${window.tttState.currentRound}/3`;
                document.getElementById('ttt-your-wins').textContent = window.tttState.yourWins;
                document.getElementById('ttt-opp-wins').textContent = window.tttState.oppWins;
                
                tttRenderBoard();
                
                const winner = tttCheckWinner(window.tttState.board);
                if (winner) {
                    window.tttState.roundEnded = true;
                    if (winner === window.tttState.playerSymbol) {
                        window.tttState.yourWins++;
                        document.getElementById('ttt-status').textContent = '‚úÖ You won this round!';
                    } else {
                        window.tttState.oppWins++;
                        document.getElementById('ttt-status').textContent = '‚ùå Opponent won this round';
                    }
                    
                    if (window.tttState.currentRound < 3) {
                        setTimeout(() => tttStartNewRound(), 2000);
                    } else {
                        tttShowFinalResult();
                    }
                } else if (window.tttState.board.every(cell => cell !== '')) {
                    window.tttState.roundEnded = true;
                    document.getElementById('ttt-status').textContent = 'ü§ù This round is a tie!';
                    
                    if (window.tttState.currentRound < 3) {
                        setTimeout(() => tttStartNewRound(), 2000);
                    } else {
                        tttShowFinalResult();
                    }
                } else {
                    const isMyTurn = game.currentPlayer === window.tttState.playerNum;
                    document.getElementById('ttt-status').classList.toggle('!bg-green-200', isMyTurn);
                    document.getElementById('ttt-status').classList.toggle('!bg-gray-200', !isMyTurn);
                    document.getElementById('ttt-status').textContent = isMyTurn ? 'üéØ Your Turn' : '‚è≥ Opponent\'s Turn';
                    
                    Array.from(document.querySelectorAll('[id^="ttt-cell-"]')).forEach(cell => {
                        cell.disabled = !isMyTurn;
                    });
                }
            });
        };

        window.tttMakeMove = async function(index) {
            if (window.tttState.board[index] !== '' || window.tttState.roundEnded) return;
            if (window.tttState.currentPlayer !== window.tttState.playerNum) return;
            
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            const newBoard = [...window.tttState.board];
            newBoard[index] = window.tttState.playerSymbol;
            
            const nextPlayer = window.tttState.playerNum === 'p1' ? 'p2' : 'p1';
            
            await updateDoc(gameRef, {
                board: newBoard,
                currentPlayer: nextPlayer
            });
        };

        window.tttCheckWinner = function(board) {
            const lines = [
                [0, 1, 2],
                [3, 4, 5],
                [6, 7, 8],
                [0, 3, 6],
                [1, 4, 7],
                [2, 5, 8],
                [0, 4, 8],
                [2, 4, 6]
            ];
            
            for (let line of lines) {
                if (board[line[0]] && board[line[0]] === board[line[1]] && board[line[1]] === board[line[2]]) {
                    return board[line[0]];
                }
            }
            return null;
        };

        window.tttRenderBoard = function() {
            window.tttState.board.forEach((cell, idx) => {
                const cellEl = document.getElementById(`ttt-cell-${idx}`);
                cellEl.textContent = cell;
                cellEl.className = `w-20 h-20 rounded text-3xl font-bold transition text-center ${
                    cell === 'X' ? 'bg-blue-100 text-blue-600' :
                    cell === 'O' ? 'bg-red-100 text-red-600' :
                    'bg-white hover:bg-gray-100'
                }`;
            });
        };

        window.tttStartNewRound = async function() {
            window.tttState.currentRound++;
            window.tttState.roundEnded = false;
            window.tttState.board = ['', '', '', '', '', '', '', '', ''];
            window.tttState.currentPlayer = 'p1';
            
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            const p1Wins = window.tttState.playerNum === 'p1' ? window.tttState.yourWins : window.tttState.oppWins;
            const p2Wins = window.tttState.playerNum === 'p1' ? window.tttState.oppWins : window.tttState.yourWins;
            
            await updateDoc(gameRef, {
                board: window.tttState.board,
                currentPlayer: 'p1',
                round: window.tttState.currentRound,
                p1_wins: p1Wins,
                p2_wins: p2Wins
            });
        };

        window.tttShowFinalResult = function() {
            window.tttState.gameOverall = true;
            
            // Check if in war mode
            const isWarMode = window.appState.currentGame && window.appState.currentGame.includes('_war');
            
            let result = '';
            if (window.tttState.yourWins > window.tttState.oppWins) {
                result = 'win';
            } else if (window.tttState.oppWins > window.tttState.yourWins) {
                result = 'lose';
            } else {
                result = 'draw';
            }
            
            if (isWarMode) {
                warGameEnd(result);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            
            let title = '', color = '', message = '';
            if (window.tttState.yourWins > window.tttState.oppWins) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
                message = `You won ${window.tttState.yourWins} out of 3 rounds!`;
            } else if (window.tttState.oppWins > window.tttState.yourWins) {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
                message = `Opponent won ${window.tttState.oppWins} out of 3 rounds!`;
            } else {
                title = 'ü§ù DRAW!';
                color = 'text-yellow-600';
                message = `Both won ${window.tttState.yourWins} rounds each!`;
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <button onclick="backToLobby()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        // ==================== WAVELENGTH GAME ====================
        window.loadWavelengthGame = function() {
            const containerId = window.gameContainerElement || 'game-container';
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-cyan-600">üìä Wavelength</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="wl-status" class="bg-cyan-100 text-cyan-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading game...</div>

                    <!-- Round Info -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg text-center border-2 border-blue-300">
                            <p class="text-sm text-gray-600">Round</p>
                            <p class="text-2xl font-bold text-blue-600" id="wl-round">1/5</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center border-2 border-purple-300">
                            <p class="text-sm text-gray-600">Your Points</p>
                            <p class="text-2xl font-bold text-purple-600" id="wl-your-points">0</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center border-2 border-orange-300">
                            <p class="text-sm text-gray-600">Opponent Points</p>
                            <p class="text-2xl font-bold text-orange-600" id="wl-opp-points">0</p>
                        </div>
                    </div>

                    <!-- Spectrum -->
                    <div id="wl-spectrum-view" class="mb-8">
                        <div class="bg-gray-100 p-6 rounded-lg mb-4">
                            <div class="flex justify-between mb-2">
                                <span class="font-bold text-gray-700" id="wl-left-label">---</span>
                                <span class="font-bold text-gray-700" id="wl-right-label">---</span>
                            </div>
                            <div class="w-full h-12 bg-gradient-to-r from-blue-400 to-red-400 rounded-lg mb-4 relative" id="wl-spectrum-bar">
                                <div id="wl-target-marker" class="hidden absolute w-1 h-14 bg-black -top-1 transform -translate-x-1/2"></div>
                                <div id="wl-guess-marker" class="hidden absolute w-2 h-14 bg-green-500 -top-1 transform -translate-x-1/2 border-2 border-green-600"></div>
                            </div>
                        </div>

                        <!-- Clue Display -->
                        <div id="wl-clue-section" class="mb-4">
                            <p class="text-sm text-gray-600 mb-2">Clue:</p>
                            <div class="bg-yellow-100 p-4 rounded-lg border-2 border-yellow-400 text-center">
                                <p id="wl-clue" class="text-2xl font-bold text-gray-800">Waiting for clue...</p>
                            </div>
                        </div>

                        <!-- Clue Input (Giver Only) -->
                        <div id="wl-give-clue" class="hidden mb-4">
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Give a One-Word Clue:</label>
                            <div class="flex gap-2">
                                <input type="text" id="wl-clue-input" maxlength="30" class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:border-cyan-500" placeholder="Enter your clue...">
                                <button onclick="wlSubmitClue()" class="bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-3 px-6 rounded-lg">Submit Clue</button>
                            </div>
                        </div>

                        <!-- Guess Slider (Guesser Only) -->
                        <div id="wl-guess-section" class="hidden mb-4">
                            <p class="text-sm text-gray-600 mb-2">Your Guess (0-100):</p>
                            <div class="flex gap-3">
                                <input type="range" id="wl-guess-slider" min="0" max="100" value="50" class="flex-grow" oninput="wlUpdateSliderDisplay(this.value)">
                                <span id="wl-guess-display" class="font-bold text-xl text-gray-800 w-12 text-center">50</span>
                            </div>
                            <button onclick="wlSubmitGuess()" class="w-full mt-3 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Submit Guess</button>
                        </div>
                    </div>

                    <!-- Result -->
                    <div id="wl-result" class="hidden bg-green-50 border-2 border-green-300 p-4 rounded-lg">
                        <p id="wl-result-text" class="text-center text-lg font-bold text-gray-800 mb-3"></p>
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <p class="text-sm text-gray-600">Target</p>
                                <p class="text-2xl font-bold text-gray-800" id="wl-result-target"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Your Guess</p>
                                <p class="text-2xl font-bold text-gray-800" id="wl-result-guess"></p>
                            </div>
                        </div>
                        <p id="wl-points-earned" class="text-center mt-3 font-bold text-cyan-600"></p>
                    </div>
                </div>
            `;

            window.wlState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                currentRound: 1,
                maxRounds: 5,
                yourPoints: 0,
                oppPoints: 0,
                spectrums: [
                    {left: 'Hot', right: 'Cold'},
                    {left: 'Safe', right: 'Dangerous'},
                    {left: 'Light', right: 'Dark'},
                    {left: 'Happy', right: 'Sad'},
                    {left: 'Fast', right: 'Slow'}
                ],
                currentSpectrum: null,
                target: null,
                clue: null,
                guess: null,
                roundEnded: false,
                gameEnded: false,
                isClueGiver: true
            };

            wlInitialize();
        };

        window.wlInitialize = async function() {
            const gameRef = doc(db, 'wlgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'wlgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    round: 1,
                    p1_points: 0,
                    p2_points: 0,
                    p1_is_giver: true,
                    p2_clue: null,
                    p1_clue: null,
                    p2_guess: null,
                    p1_guess: null,
                    spectrum_index: 0,
                    target: null,
                    status: 'clue',
                    createdAt: Date.now()
                });
            }
            
            wlListen();
        };

        window.wlListen = function() {
            const gameRef = doc(db, 'wlgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                
                window.wlState.currentRound = game.round || 1;
                window.wlState.yourPoints = window.wlState.playerNum === 'p1' ? (game.p1_points || 0) : (game.p2_points || 0);
                window.wlState.oppPoints = window.wlState.playerNum === 'p1' ? (game.p2_points || 0) : (game.p1_points || 0);
                window.wlState.isClueGiver = window.wlState.playerNum === 'p1' ? (game.p1_is_giver || true) : !(game.p1_is_giver || true);
                window.wlState.currentSpectrum = window.wlState.spectrums[game.spectrum_index || 0];
                window.wlState.target = game.target;
                window.wlState.clue = window.wlState.isClueGiver ? (window.wlState.playerNum === 'p1' ? game.p1_clue : game.p2_clue) : (window.wlState.playerNum === 'p1' ? game.p2_clue : game.p1_clue);
                
                document.getElementById('wl-round').textContent = `${window.wlState.currentRound}/5`;
                document.getElementById('wl-your-points').textContent = window.wlState.yourPoints;
                document.getElementById('wl-opp-points').textContent = window.wlState.oppPoints;
                document.getElementById('wl-left-label').textContent = window.wlState.currentSpectrum.left;
                document.getElementById('wl-right-label').textContent = window.wlState.currentSpectrum.right;
                
                if (game.status === 'clue') {
                    document.getElementById('wl-spectrum-view').classList.remove('hidden');
                    document.getElementById('wl-give-clue').classList.toggle('hidden', !window.wlState.isClueGiver);
                    document.getElementById('wl-guess-section').classList.add('hidden');
                    document.getElementById('wl-result').classList.add('hidden');
                    
                    if (window.wlState.isClueGiver) {
                        document.getElementById('wl-status').textContent = 'You are the Clue Giver - Give a one-word clue!';
                        document.getElementById('wl-clue').textContent = 'Waiting for your clue...';
                    } else {
                        document.getElementById('wl-status').textContent = 'Waiting for clue...';
                        if (game[window.wlState.playerNum === 'p1' ? 'p2_clue' : 'p1_clue']) {
                            document.getElementById('wl-clue').textContent = game[window.wlState.playerNum === 'p1' ? 'p2_clue' : 'p1_clue'];
                            document.getElementById('wl-give-clue').classList.add('hidden');
                        }
                    }
                } else if (game.status === 'guess') {
                    document.getElementById('wl-give-clue').classList.add('hidden');
                    document.getElementById('wl-guess-section').classList.toggle('hidden', !(!window.wlState.isClueGiver));
                    document.getElementById('wl-result').classList.add('hidden');
                    document.getElementById('wl-clue').textContent = window.wlState.clue || 'Waiting for clue...';
                    
                    if (window.wlState.isClueGiver) {
                        document.getElementById('wl-status').textContent = 'Opponent is guessing...';
                    } else {
                        document.getElementById('wl-status').textContent = 'Make your guess based on the clue!';
                    }
                } else if (game.status === 'result') {
                    wlShowResult(game);
                }
            });
        };

        window.wlSubmitClue = async function() {
            const clue = document.getElementById('wl-clue-input').value.trim();
            if (!clue || clue.length === 0) {
                alert('Please enter a clue');
                return;
            }
            
            const gameRef = doc(db, 'wlgames', window.appState.roomId);
            const target = Math.floor(Math.random() * 101);
            
            const updateData = {};
            updateData[`${window.wlState.playerNum}_clue`] = clue;
            updateData.target = target;
            updateData.status = 'guess';
            
            await updateDoc(gameRef, updateData);
            document.getElementById('wl-clue-input').value = '';
        };

        window.wlUpdateSliderDisplay = function(value) {
            document.getElementById('wl-guess-display').textContent = value;
        };

        window.wlSubmitGuess = async function() {
            const guess = parseInt(document.getElementById('wl-guess-slider').value);
            const gameRef = doc(db, 'wlgames', window.appState.roomId);
            
            // Calculate points based on proximity
            const diff = Math.abs(guess - window.wlState.target);
            let points = 0;
            if (diff === 0) points = 10;
            else if (diff <= 5) points = 7;
            else if (diff <= 10) points = 5;
            else if (diff <= 20) points = 3;
            else if (diff <= 30) points = 1;
            
            const updateData = {};
            updateData[`${window.wlState.playerNum}_guess`] = guess;
            updateData.status = 'result';
            updateData[window.wlState.playerNum === 'p1' ? 'p1_points' : 'p2_points'] = window.wlState.yourPoints + points;
            
            await updateDoc(gameRef, updateData);
        };

        window.wlShowResult = function(game) {
            document.getElementById('wl-give-clue').classList.add('hidden');
            document.getElementById('wl-guess-section').classList.add('hidden');
            document.getElementById('wl-result').classList.remove('hidden');
            
            const guess = window.wlState.playerNum === 'p1' ? (game.p2_guess !== null ? game.p2_guess : 'N/A') : (game.p1_guess !== null ? game.p1_guess : 'N/A');
            const diff = guess === 'N/A' ? 'N/A' : Math.abs(guess - window.wlState.target);
            
            let pointsEarned = 0;
            if (diff !== 'N/A') {
                if (diff === 0) pointsEarned = 10;
                else if (diff <= 5) pointsEarned = 7;
                else if (diff <= 10) pointsEarned = 5;
                else if (diff <= 20) pointsEarned = 3;
                else if (diff <= 30) pointsEarned = 1;
            }
            
            document.getElementById('wl-result-target').textContent = window.wlState.target;
            document.getElementById('wl-result-guess').textContent = guess;
            document.getElementById('wl-points-earned').textContent = `Opponent earned: ${pointsEarned} points`;
            document.getElementById('wl-result-text').textContent = diff === 'N/A' ? 'Round Complete' : `Distance: ${diff} positions`;
            
            // Show target marker
            const marker = document.getElementById('wl-target-marker');
            marker.classList.remove('hidden');
            marker.style.left = window.wlState.target + '%';
            
            if (guess !== 'N/A') {
                const guessMarker = document.getElementById('wl-guess-marker');
                guessMarker.classList.remove('hidden');
                guessMarker.style.left = guess + '%';
            }
            
            if (!window.wlState.roundEnded) {
                window.wlState.roundEnded = true;
                if (window.wlState.currentRound < 5) {
                    setTimeout(() => wlStartNewRound(), 3000);
                } else {
                    setTimeout(() => wlShowGameEnd(), 3000);
                }
            }
        };

        window.wlStartNewRound = async function() {
            window.wlState.currentRound++;
            window.wlState.roundEnded = false;
            window.wlState.isClueGiver = !window.wlState.isClueGiver;
            
            // Reset UI
            document.getElementById('wl-target-marker').classList.add('hidden');
            document.getElementById('wl-guess-marker').classList.add('hidden');
            document.getElementById('wl-guess-slider').value = 50;
            document.getElementById('wl-guess-display').textContent = '50';
            document.getElementById('wl-clue-input').value = '';
            
            const gameRef = doc(db, 'wlgames', window.appState.roomId);
            await updateDoc(gameRef, {
                round: window.wlState.currentRound,
                spectrum_index: window.wlState.currentRound - 1,
                p1_clue: null,
                p2_clue: null,
                p1_guess: null,
                p2_guess: null,
                target: null,
                status: 'clue',
                p1_is_giver: !((window.wlState.playerNum === 'p1' && window.wlState.isClueGiver) || (window.wlState.playerNum === 'p2' && !window.wlState.isClueGiver))
            });
        };

        window.wlShowGameEnd = function() {
            // Check if in war mode
            const isWarMode = window.appState.currentGame && window.appState.currentGame.includes('_war');
            
            let result = '';
            if (window.wlState.yourPoints > window.wlState.oppPoints) {
                result = 'win';
            } else if (window.wlState.oppPoints > window.wlState.yourPoints) {
                result = 'lose';
            } else {
                result = 'draw';
            }
            
            if (isWarMode) {
                warGameEnd(result);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            
            let title = '', color = '', message = '';
            if (window.wlState.yourPoints > window.wlState.oppPoints) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
                message = `You scored ${window.wlState.yourPoints} points! 1 Point for War.`;
            } else if (window.wlState.oppPoints > window.wlState.yourPoints) {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
                message = `Opponent scored ${window.wlState.oppPoints} points. 0 Points for War.`;
            } else {
                title = 'ü§ù DRAW!';
                color = 'text-yellow-600';
                message = `Both scored ${window.wlState.yourPoints} points! 0.5 Points for War.`;
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <button onclick="backToLobby()" class="bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        // ==================== STONE PAPER SCISSOR GAME ====================
        window.loadStonePaperGame = function() {
            const containerId = window.gameContainerElement || 'game-container';
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-yellow-600">‚úã Stone Paper Scissor</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="sps-status" class="bg-yellow-100 text-yellow-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading...</div>

                    <!-- Round Info -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg text-center border-2 border-blue-300">
                            <p class="text-sm text-gray-600">Round</p>
                            <p class="text-2xl font-bold text-blue-600" id="sps-round">1/3</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center border-2 border-purple-300">
                            <p class="text-sm text-gray-600">Your Wins</p>
                            <p class="text-2xl font-bold text-purple-600" id="sps-your-wins">0</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center border-2 border-orange-300">
                            <p class="text-sm text-gray-600">Opponent Wins</p>
                            <p class="text-2xl font-bold text-orange-600" id="sps-opp-wins">0</p>
                        </div>
                    </div>

                    <!-- Choice Buttons -->
                    <div id="sps-choices" class="mb-6">
                        <div class="grid grid-cols-3 gap-4">
                            <button onclick="spsSelectChoice('stone')" id="sps-btn-stone" class="p-8 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-3xl transition">
                                ü™® Stone
                            </button>
                            <button onclick="spsSelectChoice('paper')" id="sps-btn-paper" class="p-8 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-3xl transition">
                                üìÑ Paper
                            </button>
                            <button onclick="spsSelectChoice('scissor')" id="sps-btn-scissor" class="p-8 bg-gray-200 hover:bg-gray-300 rounded-lg font-bold text-3xl transition">
                                ‚úÇÔ∏è Scissor
                            </button>
                        </div>
                    </div>

                    <!-- Locked In Section -->
                    <div id="sps-locked" class="hidden text-center mb-6">
                        <p class="text-lg font-bold text-gray-700 mb-3">Your choice: <span id="sps-your-choice" class="text-3xl"></span></p>
                        <p id="sps-wait-message" class="text-gray-600">Waiting for opponent...</p>
                    </div>

                    <!-- Round Result -->
                    <div id="sps-result" class="hidden text-center mb-6 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                        <p id="sps-result-text" class="text-lg font-bold text-gray-800 mb-3"></p>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm text-gray-600">You</p>
                                <p class="text-3xl" id="sps-result-your"></p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600">Opponent</p>
                                <p class="text-3xl" id="sps-result-opp"></p>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            window.spsState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                currentRound: 1,
                maxRounds: 3,
                yourWins: 0,
                oppWins: 0,
                yourChoice: null,
                oppChoice: null,
                gameEnded: false,
                roundEnded: false,
                roundResults: []
            };

            spsInitialize();
        };

        window.spsInitialize = async function() {
            const gameRef = doc(db, 'spsgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'spsgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    round: 1,
                    p1_choice: null,
                    p2_choice: null,
                    p1_wins: 0,
                    p2_wins: 0,
                    status: 'playing',
                    results: [],
                    createdAt: Date.now()
                });
            }
            
            spsListen();
        };

        window.spsListen = function() {
            const gameRef = doc(db, 'spsgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                
                window.spsState.currentRound = game.round || 1;
                window.spsState.yourWins = window.spsState.playerNum === 'p1' ? (game.p1_wins || 0) : (game.p2_wins || 0);
                window.spsState.oppWins = window.spsState.playerNum === 'p1' ? (game.p2_wins || 0) : (game.p1_wins || 0);
                window.spsState.yourChoice = window.spsState.playerNum === 'p1' ? game.p1_choice : game.p2_choice;
                window.spsState.oppChoice = window.spsState.playerNum === 'p1' ? game.p2_choice : game.p1_choice;
                
                document.getElementById('sps-round').textContent = `${window.spsState.currentRound}/3`;
                document.getElementById('sps-your-wins').textContent = window.spsState.yourWins;
                document.getElementById('sps-opp-wins').textContent = window.spsState.oppWins;
                
                // Both choices made
                if (window.spsState.yourChoice && window.spsState.oppChoice) {
                    document.getElementById('sps-choices').classList.add('hidden');
                    document.getElementById('sps-locked').classList.add('hidden');
                    document.getElementById('sps-result').classList.remove('hidden');
                    
                    const result = spsCalculateRound(window.spsState.yourChoice, window.spsState.oppChoice);
                    
                    const choiceEmojis = {stone: 'ü™®', paper: 'üìÑ', scissor: '‚úÇÔ∏è'};
                    document.getElementById('sps-result-your').textContent = choiceEmojis[window.spsState.yourChoice];
                    document.getElementById('sps-result-opp').textContent = choiceEmojis[window.spsState.oppChoice];
                    
                    if (result === 'win') {
                        document.getElementById('sps-result-text').textContent = '‚úÖ You Win This Round!';
                        document.getElementById('sps-result').classList.remove('border-yellow-300', 'bg-yellow-50');
                        document.getElementById('sps-result').classList.add('border-green-300', 'bg-green-50');
                    } else if (result === 'lose') {
                        document.getElementById('sps-result-text').textContent = '‚ùå Opponent Wins This Round';
                        document.getElementById('sps-result').classList.remove('border-yellow-300', 'bg-yellow-50');
                        document.getElementById('sps-result').classList.add('border-red-300', 'bg-red-50');
                    } else {
                        document.getElementById('sps-result-text').textContent = 'ü§ù This Round is a Tie!';
                        document.getElementById('sps-result').classList.remove('border-yellow-300', 'bg-yellow-50');
                        document.getElementById('sps-result').classList.add('border-yellow-300', 'bg-yellow-50');
                    }
                    
                    if (!window.spsState.roundEnded) {
                        window.spsState.roundEnded = true;
                        if (window.spsState.currentRound < 3) {
                            setTimeout(() => spsStartNewRound(), 2500);
                        } else {
                            setTimeout(() => spsShowFinalResult(), 2500);
                        }
                    }
                } else if (window.spsState.yourChoice && !window.spsState.oppChoice) {
                    // Waiting for opponent
                    document.getElementById('sps-choices').classList.add('hidden');
                    document.getElementById('sps-locked').classList.remove('hidden');
                    document.getElementById('sps-result').classList.add('hidden');
                    
                    const choiceEmojis = {stone: 'ü™®', paper: 'üìÑ', scissor: '‚úÇÔ∏è'};
                    document.getElementById('sps-your-choice').textContent = choiceEmojis[window.spsState.yourChoice];
                    document.getElementById('sps-wait-message').textContent = '‚è≥ Waiting for opponent to choose...';
                } else {
                    // Selection phase
                    document.getElementById('sps-choices').classList.remove('hidden');
                    document.getElementById('sps-locked').classList.add('hidden');
                    document.getElementById('sps-result').classList.add('hidden');
                    document.getElementById('sps-status').textContent = `Round ${window.spsState.currentRound}/3 - Make your choice!`;
                }
            });
        };

        window.spsSelectChoice = async function(choice) {
            if (window.spsState.yourChoice) return;
            
            window.spsState.yourChoice = choice;
            const gameRef = doc(db, 'spsgames', window.appState.roomId);
            const updateData = {};
            updateData[`${window.spsState.playerNum}_choice`] = choice;
            
            await updateDoc(gameRef, updateData);
        };

        window.spsCalculateRound = function(yourChoice, oppChoice) {
            if (yourChoice === oppChoice) return 'tie';
            
            const wins = {
                stone: 'scissor',
                paper: 'stone',
                scissor: 'paper'
            };
            
            return wins[yourChoice] === oppChoice ? 'win' : 'lose';
        };

        window.spsStartNewRound = async function() {
            window.spsState.currentRound++;
            window.spsState.roundEnded = false;
            window.spsState.yourChoice = null;
            window.spsState.oppChoice = null;
            
            const gameRef = doc(db, 'spsgames', window.appState.roomId);
            const p1Wins = window.spsState.playerNum === 'p1' ? window.spsState.yourWins : window.spsState.oppWins;
            const p2Wins = window.spsState.playerNum === 'p1' ? window.spsState.oppWins : window.spsState.yourWins;
            
            await updateDoc(gameRef, {
                round: window.spsState.currentRound,
                p1_choice: null,
                p2_choice: null,
                p1_wins: p1Wins,
                p2_wins: p2Wins
            });
        };

        window.spsShowFinalResult = function() {
            // Check if in war mode
            const isWarMode = window.appState.currentGame && window.appState.currentGame.includes('_war');
            
            let result = '';
            if (window.spsState.yourWins > window.spsState.oppWins) {
                result = 'win';
            } else if (window.spsState.oppWins > window.spsState.yourWins) {
                result = 'lose';
            } else {
                result = 'draw';
            }
            
            if (isWarMode) {
                warGameEnd(result);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            
            // Calculate overall result based on wins logic
            let title = '', color = '', message = '';
            
            if (window.spsState.yourWins > window.spsState.oppWins) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
                message = `You won ${window.spsState.yourWins} rounds! 1 Point for War.`;
            } else if (window.spsState.oppWins > window.spsState.yourWins) {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
                message = `Opponent won ${window.spsState.oppWins} rounds. 0 Points for War.`;
            } else {
                title = 'ü§ù DRAW!';
                color = 'text-yellow-600';
                message = `Both won ${window.spsState.yourWins} rounds each! 0.5 Points for War.`;
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <button onclick="backToLobby()" class="bg-yellow-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        // ==================== FAST FOUR GAME ====================
        window.loadFastFourGame = function() {
            const containerId = window.gameContainerElement || 'game-container';
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-pink-600">üéØ Fast Four</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="ff-status" class="bg-pink-100 text-pink-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading...</div>

                    <!-- Phase 1: Selection -->
                    <div id="ff-selection-phase" class="mb-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Phase 1: Select Your 4 Gold Blocks</h3>
                        <p class="text-gray-600 mb-4">Click 4 different blocks to set as your treasures. Opponent will try to guess them!</p>
                        
                        <div class="grid grid-cols-4 gap-3 mb-4" id="ff-select-board">
                            ${Array(16).fill(0).map((_, i) => 
                                `<button onclick="ffSelectBlock(${i})" id="ff-sel-${i}" class="aspect-square bg-gray-200 border-2 border-gray-400 rounded-lg font-bold text-2xl hover:bg-gray-300 transition"></button>`
                            ).join('')}
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-gray-600">Selected: <span id="ff-selected-count">0</span>/4</p>
                        </div>
                        
                        <button onclick="ffLockInGolds()" id="ff-lock-btn" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-bold py-3 rounded-lg transition disabled:opacity-50" disabled>
                            Lock In Gold Positions
                        </button>
                    </div>

                    <!-- Phase 2: Waiting & Guessing -->
                    <div id="ff-guessing-phase" class="hidden mb-8">
                        <div class="grid grid-cols-2 gap-8 mb-6">
                            <!-- Your Board (Opponent Guessing) -->
                            <div>
                                <h4 class="font-bold text-lg mb-3 text-gray-800">Opponent's Guesses</h4>
                                <div class="grid grid-cols-4 gap-2" id="ff-your-board">
                                    ${Array(16).fill(0).map((_, i) => 
                                        `<div id="ff-your-${i}" class="aspect-square bg-gray-100 border-2 border-gray-300 rounded-lg flex items-center justify-center font-bold text-xl"></div>`
                                    ).join('')}
                                </div>
                                <p class="text-sm text-gray-600 mt-2">Opponent guessed: <span id="ff-opp-guessed">0</span>/4</p>
                            </div>

                            <!-- Opponent's Board (You Guessing) -->
                            <div>
                                <h4 class="font-bold text-lg mb-3 text-gray-800">Your Guesses</h4>
                                <div class="grid grid-cols-4 gap-2" id="ff-guess-board">
                                    ${Array(16).fill(0).map((_, i) => 
                                        `<button onclick="ffGuessBlock(${i})" id="ff-guess-${i}" class="aspect-square bg-blue-200 border-2 border-blue-400 rounded-lg font-bold text-xl hover:bg-blue-300 transition"></button>`
                                    ).join('')}
                                </div>
                                <p class="text-sm text-gray-600 mt-2">You guessed: <span id="ff-you-guessed">0</span>/4</p>
                            </div>
                        </div>

                        <div id="ff-turn-info" class="text-center font-bold text-lg text-gray-800 mb-4"></div>
                    </div>

                    <!-- Phase 3: Locked In (Waiting) -->
                    <div id="ff-waiting-phase" class="hidden text-center">
                        <p class="text-lg font-bold text-gray-700 mb-4">‚è≥ Waiting for opponent to lock in their gold positions...</p>
                    </div>
                </div>
            `;

            window.ffState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                selectedGolds: [],
                myGolds: [],
                oppGolds: [],
                myGuesses: [],
                oppGuesses: [],
                lockedIn: false,
                oppLockedIn: false,
                gameEnded: false,
                winner: null,
                phase: 'selection' // selection, guessing, ended
            };

            ffInitialize();
        };

        window.ffInitialize = async function() {
            const gameRef = doc(db, 'ffgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'ffgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    p1_golds: null,
                    p2_golds: null,
                    p1_guesses: [],
                    p2_guesses: [],
                    turn: 'p1',
                    status: 'selection',
                    createdAt: Date.now()
                });
            }
            
            ffListen();
        };

        window.ffListen = function() {
            const gameRef = doc(db, 'ffgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                
                const opp = window.ffState.playerNum === 'p1' ? 'p2' : 'p1';
                window.ffState.myGolds = game[`${window.ffState.playerNum}_golds`] || [];
                window.ffState.oppGolds = game[`${opp}_golds`] || [];
                window.ffState.myGuesses = game[`${window.ffState.playerNum}_guesses`] || [];
                window.ffState.oppGuesses = game[`${opp}_guesses`] || [];
                window.ffState.phase = game.status;
                
                if (game.status === 'selection') {
                    document.getElementById('ff-selection-phase').classList.remove('hidden');
                    document.getElementById('ff-guessing-phase').classList.add('hidden');
                    document.getElementById('ff-waiting-phase').classList.add('hidden');
                    
                    if (!window.ffState.myGolds.length) {
                        document.getElementById('ff-status').textContent = 'Select your 4 gold blocks';
                    } else {
                        document.getElementById('ff-status').textContent = 'Waiting for opponent...';
                        document.getElementById('ff-selection-phase').classList.add('hidden');
                        document.getElementById('ff-waiting-phase').classList.remove('hidden');
                    }
                } else if (game.status === 'guessing') {
                    document.getElementById('ff-selection-phase').classList.add('hidden');
                    document.getElementById('ff-waiting-phase').classList.add('hidden');
                    document.getElementById('ff-guessing-phase').classList.remove('hidden');
                    
                    const isMyTurn = game.turn === window.ffState.playerNum;
                    document.getElementById('ff-turn-info').textContent = isMyTurn ? 'üéØ Your Turn to Guess' : '‚è≥ Opponent is Guessing';
                    
                    // Disable/enable guessing buttons
                    Array.from(document.querySelectorAll('[id^="ff-guess-"]')).forEach((btn, idx) => {
                        btn.disabled = !isMyTurn || window.ffState.myGuesses.some(g => g.index === idx);
                    });
                    
                    ffRenderBoards();
                    ffCheckGameEnd();
                }
                
                if (game.status === 'ended') {
                    ffShowGameEnd();
                }
            });
        };

        window.ffSelectBlock = function(index) {
            if (window.ffState.selectedGolds.includes(index)) {
                window.ffState.selectedGolds = window.ffState.selectedGolds.filter(i => i !== index);
            } else if (window.ffState.selectedGolds.length < 4) {
                window.ffState.selectedGolds.push(index);
            } else {
                return;
            }
            
            // Update UI
            document.getElementById('ff-selected-count').textContent = window.ffState.selectedGolds.length;
            Array.from(document.querySelectorAll('[id^="ff-sel-"]')).forEach((btn, idx) => {
                if (window.ffState.selectedGolds.includes(idx)) {
                    btn.classList.add('bg-pink-400', 'border-pink-600');
                    btn.textContent = '‚ú®';
                } else {
                    btn.classList.remove('bg-pink-400', 'border-pink-600');
                    btn.textContent = '';
                }
            });
            
            document.getElementById('ff-lock-btn').disabled = window.ffState.selectedGolds.length !== 4;
        };

        window.ffLockInGolds = async function() {
            const gameRef = doc(db, 'ffgames', window.appState.roomId);
            const updateData = {};
            updateData[`${window.ffState.playerNum}_golds`] = window.ffState.selectedGolds;
            
            // Check if both players locked in
            const gameSnap = await getDocs(query(collection(db, 'ffgames'), where('roomId', '==', window.appState.roomId)));
            const game = gameSnap.docs[0].data();
            const opp = window.ffState.playerNum === 'p1' ? 'p2' : 'p1';
            
            if (game[`${opp}_golds`]) {
                updateData.status = 'guessing';
            }
            
            await updateDoc(gameRef, updateData);
        };

        window.ffGuessBlock = async function(index) {
            if (window.ffState.myGuesses.some(g => g.index === index)) return;
            if (window.ffState.myGuesses.length >= 4) return;
            
            const gameRef = doc(db, 'ffgames', window.appState.roomId);
            const opp = window.ffState.playerNum === 'p1' ? 'p2' : 'p1';
            const isGold = window.ffState.oppGolds.includes(index);
            
            const newGuess = {
                index: index,
                isGold: isGold,
                timestamp: Date.now()
            };
            
            let newStatus = 'guessing';
            let nextTurn = opp;
            
            // Check if player won
            const guessedGolds = [...window.ffState.myGuesses.map(g => g.index), index].filter(idx => window.ffState.oppGolds.includes(idx));
            if (guessedGolds.length === 4) {
                newStatus = `${window.ffState.playerNum}_won`;
            } else if (window.ffState.myGuesses.length + 1 === 4 && window.ffState.oppGuesses.length === 4) {
                // Both players out of guesses
                const oppGuessedGolds = window.ffState.oppGuesses.filter(g => g.isGold).length;
                if (oppGuessedGolds < 4) {
                    newStatus = `${window.ffState.playerNum}_won`;
                } else {
                    newStatus = 'draw';
                }
            }
            
            await updateDoc(gameRef, {
                [`${window.ffState.playerNum}_guesses`]: arrayUnion(newGuess),
                turn: nextTurn,
                status: newStatus
            });
        };

        window.ffRenderBoards = function() {
            // Your board (opponent guessing)
            window.ffState.oppGuesses.forEach(guess => {
                const cell = document.getElementById(`ff-your-${guess.index}`);
                if (guess.isGold) {
                    cell.textContent = '‚úì';
                    cell.classList.add('bg-green-300', 'border-green-600');
                } else {
                    cell.textContent = '‚úó';
                    cell.classList.add('bg-red-300', 'border-red-600');
                }
            });
            
            // Opponent's board (your guessing)
            window.ffState.myGuesses.forEach(guess => {
                const cell = document.getElementById(`ff-guess-${guess.index}`);
                if (guess.isGold) {
                    cell.textContent = '‚úì';
                    cell.classList.remove('bg-blue-200', 'border-blue-400', 'hover:bg-blue-300');
                    cell.classList.add('bg-green-300', 'border-green-600');
                } else {
                    cell.textContent = '‚úó';
                    cell.classList.remove('bg-blue-200', 'border-blue-400', 'hover:bg-blue-300');
                    cell.classList.add('bg-red-300', 'border-red-600');
                }
            });
            
            document.getElementById('ff-you-guessed').textContent = window.ffState.myGuesses.length;
            document.getElementById('ff-opp-guessed').textContent = window.ffState.oppGuesses.length;
        };

        window.ffCheckGameEnd = function() {
            const myGoldCount = window.ffState.myGuesses.filter(g => g.isGold).length;
            const oppGoldCount = window.ffState.oppGuesses.filter(g => g.isGold).length;
            
            if (myGoldCount === 4) {
                window.ffState.winner = window.ffState.playerNum;
                window.ffState.gameEnded = true;
                ffShowGameEnd();
            } else if (oppGoldCount === 4) {
                window.ffState.winner = window.ffState.playerNum === 'p1' ? 'p2' : 'p1';
                window.ffState.gameEnded = true;
                ffShowGameEnd();
            }
        };

        window.ffShowGameEnd = function() {
            if (window.ffState.gameEnded) return;
            window.ffState.gameEnded = true;
            
            // Check if in war mode
            const isWarMode = window.appState.currentGame && window.appState.currentGame.includes('_war');
            
            let result = window.ffState.winner === window.ffState.playerNum ? 'win' : 'lose';
            
            if (isWarMode) {
                warGameEnd(result);
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            
            let title = '', color = '', message = '';
            if (window.ffState.winner === window.ffState.playerNum) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
                message = 'You found all 4 gold blocks first! 1 Point for War.';
            } else {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
                message = 'Opponent found all 4 gold blocks first. 0 Points for War.';
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <button onclick="backToLobby()" class="bg-pink-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        window.startWar = function() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert('Please enter your name first!');
                return;
            }
            window.appState.username = username;
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('war-screen').classList.remove('hidden');
        };

        window.warGoBack = function() {
            document.getElementById('war-screen').classList.add('hidden');
            document.getElementById('landing-screen').classList.remove('hidden');
        };

        window.confirmWar = async function() {
            const warCode = Math.random().toString(36).substr(2, 6).toUpperCase();
            window.appState.warCode = warCode;
            window.appState.warRoomId = warCode;
            window.appState.playerNumber = 1;
            
            try {
                const warRef = doc(db, 'wars', warCode);
                await setDoc(warRef, {
                    id: warCode,
                    p1_id: window.appState.userId,
                    p1_name: window.appState.username,
                    p2_id: null,
                    p2_name: null,
                    status: 'waiting',
                    gameSequence: ['codebreaker', 'tictactoe', 'stonepaper', 'fastfour', 'wavelength'],
                    currentGameIndex: 0,
                    p1_points: 0,
                    p2_points: 0,
                    gameResults: {},
                    createdAt: new Date().toISOString()
                });
                
                document.getElementById('war-screen').classList.add('hidden');
                document.getElementById('war-lobby-screen').classList.remove('hidden');
                document.getElementById('war-code-display').textContent = warCode;
                document.getElementById('war-your-name').textContent = window.appState.username;
                listenToWarStatus();
            } catch (error) {
                console.error('Error creating war:', error);
            }
        };

        window.warJoinConfirm = async function() {
            const warCode = document.getElementById('war-code-join').value.trim().toUpperCase();
            if (!warCode) {
                document.getElementById('war-join-message').textContent = 'Please enter a war code';
                return;
            }
            
            try {
                const warRef = doc(db, 'wars', warCode);
                const warSnap = await getDoc(warRef);
                
                if (!warSnap.exists()) {
                    document.getElementById('war-join-message').textContent = 'War code not found';
                    return;
                }
                
                const warData = warSnap.data();
                if (warData.status === 'in-progress' || warData.status === 'completed') {
                    document.getElementById('war-join-message').textContent = 'War already in progress or completed';
                    return;
                }
                
                if (warData.p2_id) {
                    document.getElementById('war-join-message').textContent = 'War room is full';
                    return;
                }
                
                window.appState.warCode = warCode;
                window.appState.warRoomId = warCode;
                window.appState.playerNumber = 2;
                
                await updateDoc(warRef, {
                    p2_id: window.appState.userId,
                    p2_name: window.appState.username,
                    status: 'in-progress'
                });
                
                document.getElementById('war-screen').classList.add('hidden');
                document.getElementById('war-lobby-screen').classList.remove('hidden');
                document.getElementById('war-code-display').textContent = warCode;
                document.getElementById('war-your-name').textContent = window.appState.username;
                listenToWarStatus();
            } catch (error) {
                console.error('Error joining war:', error);
                document.getElementById('war-join-message').textContent = 'Error joining war';
            }
        };

        window.listenToWarStatus = function() {
            const warRef = doc(db, 'wars', window.appState.warCode);
            onSnapshot(warRef, (warSnap) => {
                if (!warSnap.exists()) return;
                
                const warData = warSnap.data();
                window.appState.warData = warData;
                
                const opponentName = window.appState.playerNumber === 1 ? warData.p2_name : warData.p1_name;
                document.getElementById('war-opponent-name').textContent = opponentName || 'Waiting for opponent...';
                
                if (warData.status === 'in-progress' && opponentName && warData.p1_id && warData.p2_id) {
                    document.getElementById('war-start-button').disabled = false;
                    document.getElementById('war-waiting-message').classList.add('hidden');
                } else if (warData.status !== 'in-progress' && warData.p1_id && warData.p2_id) {
                    document.getElementById('war-start-button').disabled = false;
                    document.getElementById('war-waiting-message').classList.add('hidden');
                }
            });
        };

        window.startWarGames = async function() {
            if (!window.appState.warData.p1_id || !window.appState.warData.p2_id) {
                alert('Waiting for opponent to join...');
                return;
            }
            
            document.getElementById('war-lobby-screen').classList.add('hidden');
            document.getElementById('war-game-screen').classList.remove('hidden');
            
            // Show start prompt instead of directly starting
            showWarStartPrompt();
            listenToWarFromLobby();
        };

        window.startNextWarGame = async function() {
            const gameSeq = window.appState.warData.gameSequence;
            const currentIdx = window.appState.warData.currentGameIndex;
            
            if (currentIdx >= gameSeq.length) {
                showWarSummary();
                return;
            }
            
            const currentGame = gameSeq[currentIdx];
            window.appState.currentGame = currentGame + '_war';
            window.appState.roomId = window.appState.warCode; // Use war code as roomId for games
            
            const gameTitle = {
                'codebreaker': 'üîê Code Breaker',
                'tictactoe': '‚≠ï Tic Tac Toe',
                'stonepaper': '‚úã Stone Paper',
                'fastfour': 'üéØ Fast Four',
                'wavelength': 'üìä Wavelength'
            };
            
            document.getElementById('war-game-title').textContent = gameTitle[currentGame];
            document.getElementById('war-game-number').textContent = `Game ${currentIdx + 1} of 5`;
            
            // Update player names and scores
            document.getElementById('war-p1-name').textContent = window.appState.warData.p1_name;
            document.getElementById('war-p2-name').textContent = window.appState.warData.p2_name;
            document.getElementById('war-p1-score').textContent = window.appState.warData.p1_points.toFixed(1);
            document.getElementById('war-p2-score').textContent = window.appState.warData.p2_points.toFixed(1);
            
            document.getElementById('war-game-progress').innerHTML = '';
            for (let i = 0; i < gameSeq.length; i++) {
                const status = i < currentIdx ? 'done' : i === currentIdx ? 'active' : 'pending';
                const statusClass = status === 'done' ? 'bg-green-500' : status === 'active' ? 'bg-blue-500' : 'bg-gray-300';
                document.getElementById('war-game-progress').innerHTML += `<div class="${statusClass} h-2 flex-1"></div>`;
            }
            
            loadGame(currentGame);
        };

        window.warGameEnd = async function(result) {
            const currentIdx = window.appState.warData.currentGameIndex;
            const gameSeq = window.appState.warData.gameSequence;
            const currentGame = gameSeq[currentIdx];
            
            let points = 0;
            if (result === 'win') {
                points = 1;
            } else if (result === 'draw') {
                points = 0.5;
            } else {
                points = 0;
            }
            
            const fieldName = window.appState.playerNumber === 1 ? 'p1_points' : 'p2_points';
            const resultFieldName = window.appState.playerNumber === 1 ? 'p1_result' : 'p2_result';
            
            // Store this player's result
            const updateObj = {
                [fieldName]: window.appState.warData[fieldName] + points,
                [`gameResults.${currentGame}.${resultFieldName}`]: result
            };
            
            try {
                const warRef = doc(db, 'wars', window.appState.warCode);
                await updateDoc(warRef, updateObj);
                
                // Wait for both players' results, then advance
                const checkInterval = setInterval(async () => {
                    const warSnap = await getDoc(warRef);
                    if (warSnap.exists()) {
                        const warData = warSnap.data();
                        const gameResult = warData.gameResults?.[currentGame];
                        
                        // Check if both players have reported
                        if (gameResult?.p1_result && gameResult?.p2_result) {
                            clearInterval(checkInterval);
                            
                            // Only player 1 advances the game index
                            if (window.appState.playerNumber === 1) {
                                await updateDoc(warRef, {
                                    currentGameIndex: currentIdx + 1
                                });
                            }
                            
                            // Refresh war data
                            const updatedSnap = await getDoc(warRef);
                            window.appState.warData = updatedSnap.data();
                            
                            setTimeout(() => {
                                if (currentIdx + 1 >= gameSeq.length) {
                                    showWarSummary();
                                } else {
                                    startNextWarGame();
                                }
                            }, 1500);
                        }
                    }
                }, 500);
            } catch (error) {
                console.error('Error updating war game:', error);
            }
        };

        window.showWarSummary = function() {
            const warData = window.appState.warData;
            const p1Points = warData.p1_points;
            const p2Points = warData.p2_points;
            
            let result = '';
            if (p1Points > p2Points) {
                result = window.appState.playerNumber === 1 ? 'üéâ YOU WIN THE WAR!' : 'üò¢ YOU LOSE THE WAR!';
            } else if (p2Points > p1Points) {
                result = window.appState.playerNumber === 2 ? 'üéâ YOU WIN THE WAR!' : 'üò¢ YOU LOSE THE WAR!';
            } else {
                result = 'ü§ù THE WAR IS A DRAW!';
            }
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
            
            let resultsHTML = '<div class="mb-4">';
            const games = ['codebreaker', 'tictactoe', 'stonepaper', 'fastfour', 'wavelength'];
            const gameNames = ['Code Breaker', 'Tic Tac Toe', 'Stone Paper', 'Fast Four', 'Wavelength'];
            
            games.forEach((game, idx) => {
                const result = warData.gameResults[game];
                const p1pts = result?.p1_points || 0;
                const p2pts = result?.p2_points || 0;
                resultsHTML += `<div class="flex justify-between text-gray-700 mb-2"><span>${gameNames[idx]}</span><span>${p1pts} - ${p2pts}</span></div>`;
            });
            resultsHTML += '</div>';
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-4xl font-black mb-4 text-purple-600">${result}</h3>
                <div class="bg-gray-100 p-4 rounded-lg mb-6">
                    ${resultsHTML}
                    <div class="border-t pt-3 mt-3 font-bold">
                        <div class="flex justify-between text-lg">
                            <span>${warData.p1_name}</span><span>${p1Points}</span>
                        </div>
                        <div class="flex justify-between text-lg">
                            <span>${warData.p2_name}</span><span>${p2Points}</span>
                        </div>
                    </div>
                </div>
                <button onclick="exitWarAndReturn()" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg">Back to Home</button>
            </div>`;
            document.body.appendChild(modal);
        };

        window.exitWarAndReturn = function() {
            window.appState.warCode = null;
            window.appState.warData = null;
            document.querySelectorAll('.fixed').forEach(el => el.remove());
            document.getElementById('war-game-screen').classList.add('hidden');
            document.getElementById('war-lobby-screen').classList.add('hidden');
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('landing-screen').classList.remove('hidden');
        };

        window.exitWarLobby = async function() {
            if (confirm('Are you sure you want to exit the war lobby?')) {
                try {
                    if (window.appState.warCode) {
                        const warRef = doc(db, 'wars', window.appState.warCode);
                        await deleteDoc(warRef);
                    }
                    window.appState.warCode = null;
                    window.appState.warData = null;
                    document.getElementById('war-lobby-screen').classList.add('hidden');
                    document.getElementById('landing-screen').classList.remove('hidden');
                } catch (error) {
                    console.error('Error exiting war lobby:', error);
                }
            }
        };

        window.exitWarGame = function() {
            if (confirm('Are you sure you want to exit the war? Your progress will be lost.')) {
                exitWarAndReturn();
            }
        };

        window.startWarFromLobby = async function() {
            if (!window.appState.roomId) {
                alert('You need to be in a room first!');
                return;
            }

            // Get room data to check if both players are present
            const roomRef = doc(db, 'rooms', window.appState.roomId);
            const roomSnap = await getDoc(roomRef);
            
            if (!roomSnap.exists()) {
                alert('Room not found!');
                return;
            }

            const roomData = roomSnap.data();
            if (!roomData.p1_id || !roomData.p2_id) {
                alert('Both players must be in the room to start a war!');
                return;
            }

            if (!confirm('Start a WAR with your opponent? You will battle through all 5 games!')) {
                return;
            }

            // Create war using existing room data
            const warCode = window.appState.roomId; // Use same room ID for war
            window.appState.warCode = warCode;
            window.appState.warRoomId = warCode;

            try {
                const warRef = doc(db, 'wars', warCode);
                await setDoc(warRef, {
                    id: warCode,
                    p1_id: roomData.p1_id,
                    p1_name: roomData.p1_name,
                    p2_id: roomData.p2_id,
                    p2_name: roomData.p2_name,
                    status: 'ready',
                    gameSequence: ['codebreaker', 'tictactoe', 'stonepaper', 'fastfour', 'wavelength'],
                    currentGameIndex: 0,
                    p1_points: 0,
                    p2_points: 0,
                    gameResults: {},
                    createdAt: new Date().toISOString()
                });

                // Hide lobby and show war game screen
                document.getElementById('lobby-screen').classList.add('hidden');
                document.getElementById('war-game-screen').classList.remove('hidden');
                
                // Listen for war updates
                listenToWarFromLobby();
                
                // Show start button
                showWarStartPrompt();
            } catch (error) {
                console.error('Error creating war from lobby:', error);
                alert('Failed to start war. Please try again.');
            }
        };

        window.listenToWarFromLobby = function() {
            const warRef = doc(db, 'wars', window.appState.warCode);
            onSnapshot(warRef, (warSnap) => {
                if (!warSnap.exists()) return;
                
                const warData = warSnap.data();
                window.appState.warData = warData;
                
                // Update display
                document.getElementById('war-p1-name').textContent = warData.p1_name;
                document.getElementById('war-p2-name').textContent = warData.p2_name;
                document.getElementById('war-p1-score').textContent = warData.p1_points.toFixed(1);
                document.getElementById('war-p2-score').textContent = warData.p2_points.toFixed(1);
                
                // Check if war should start
                if (warData.status === 'in-progress' && warData.currentGameIndex === 0) {
                    document.querySelectorAll('.war-start-modal').forEach(el => el.remove());
                    startNextWarGame();
                }
            });
        };

        window.showWarStartPrompt = function() {
            const modal = document.createElement('div');
            modal.className = 'war-start-modal fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.innerHTML = `<div class="bg-gradient-to-br from-gray-800 to-gray-900 border-2 border-red-500/50 rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 bg-gradient-to-r from-red-400 to-orange-500 bg-clip-text text-transparent">‚öîÔ∏è WAR IS READY!</h3>
                <p class="text-gray-300 mb-6">Both warriors are ready. Click below to begin the 5-game battle!</p>
                <button onclick="startWarBattle()" class="bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 px-8 rounded-lg transition shadow-lg transform hover:scale-105">
                    ‚öîÔ∏è START WAR
                </button>
            </div>`;
            document.body.appendChild(modal);
        };

        window.startWarBattle = async function() {
            try {
                const warRef = doc(db, 'wars', window.appState.warCode);
                await updateDoc(warRef, {
                    status: 'in-progress'
                });
                document.querySelectorAll('.war-start-modal').forEach(el => el.remove());
                startNextWarGame();
            } catch (error) {
                console.error('Error starting war battle:', error);
            }
        };

        console.log('Ka re? Platform Ready');
    </script>
</body>
</html>
