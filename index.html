<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ka re? - Multi-Game Battle Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 min-h-screen">
    
    <div id="app" class="min-h-screen p-4 md:p-8">
        
        <!-- LANDING SCREEN -->
        <div id="landing-screen" class="flex items-center justify-center min-h-screen">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl p-8 fade-in">
                <h1 class="text-5xl font-black text-center text-purple-600 mb-2">Ka re?</h1>
                <p class="text-center text-gray-600 mb-8 text-lg">Multi-Game Battle Platform</p>
                
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Your Name</label>
                    <input type="text" id="username-input" maxlength="20" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:ring-2 focus:ring-purple-200 transition" placeholder="Enter your name...">
                </div>
                
                <div class="space-y-3">
                    <button onclick="goToRoomSelect()" class="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        üéÆ Play a Game
                    </button>
                    <button onclick="startWar()" class="w-full bg-gradient-to-r from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        ‚öîÔ∏è Declare a War
                    </button>
                </div>
            </div>
        </div>

        <!-- ROOM SELECTION SCREEN -->
        <div id="room-screen" class="hidden min-h-screen flex items-center justify-center">
            <div class="w-full max-w-2xl bg-white rounded-2xl shadow-2xl p-8 fade-in">
                <button onclick="goBack()" class="mb-6 text-purple-600 hover:text-purple-800 font-semibold">‚Üê Back</button>
                <h2 class="text-3xl font-bold text-gray-800 mb-6">Room Selection</h2>
                
                <div class="mb-6">
                    <p class="text-gray-700 mb-3 font-semibold">Hello, <span id="room-username" class="text-purple-600"></span>!</p>
                </div>

                <div class="bg-gradient-to-r from-green-50 to-blue-50 p-6 rounded-lg mb-6 border-2 border-green-300">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Create New Room</h3>
                    <button onclick="createRoom()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        ‚ú® Create Room
                    </button>
                </div>

                <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-6 rounded-lg border-2 border-blue-300">
                    <h3 class="text-xl font-bold text-gray-800 mb-3">Join Existing Room</h3>
                    <input type="text" id="room-code-input" maxlength="6" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition mb-3 text-center tracking-widest text-lg" placeholder="e.g. ABC123">
                    <button onclick="joinRoom()" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg transition shadow-lg">
                        üîó Join Room
                    </button>
                    <p id="join-message" class="text-red-500 text-sm mt-2 h-5"></p>
                </div>
            </div>
        </div>

        <!-- LOBBY SCREEN -->
        <div id="lobby-screen" class="hidden min-h-screen">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-2xl shadow-2xl p-6 mb-6 fade-in">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-800">Game Lobby</h2>
                            <p class="text-gray-600">Room: <span id="lobby-room-id" class="font-mono font-bold text-purple-600 text-lg"></span></p>
                        </div>
                        <button onclick="exitRoom()" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition">
                            Exit Room
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300">
                            <p class="text-sm text-gray-600">Your Name</p>
                            <p class="text-xl font-bold text-blue-600" id="lobby-your-name"></p>
                        </div>
                        <div class="bg-orange-50 p-4 rounded-lg border-2 border-orange-300">
                            <p class="text-sm text-gray-600">Opponent</p>
                            <p class="text-xl font-bold text-orange-600" id="lobby-opponent-name">Waiting...</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-2xl p-6 fade-in">
                    <h3 class="text-2xl font-bold text-gray-800 mb-4">Select a Game</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <button onclick="selectGame('codebreaker')" class="p-6 bg-gradient-to-br from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            üîê Code Breaker
                        </button>
                        <button onclick="selectGame('tictactoe')" class="p-6 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            ‚≠ï Tic Tac Toe
                        </button>
                        <button onclick="selectGame('wavelength')" class="p-6 bg-gradient-to-br from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            üìä Wavelength
                        </button>
                        <button onclick="selectGame('stonepaper')" class="p-6 bg-gradient-to-br from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            ‚úã Stone Paper
                        </button>
                        <button onclick="selectGame('fastfour')" class="p-6 bg-gradient-to-br from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white rounded-lg font-bold shadow-lg transition transform hover:scale-105">
                            üéØ Fast Four
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- GAME CONTAINER -->
        <div id="game-container" class="hidden"></div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, getDocs, updateDoc, arrayUnion, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAydXymmuO9r9xFC5S8b-eMI-dLnbrcP1w",
            authDomain: "code-breaker-duel.firebaseapp.com",
            projectId: "code-breaker-duel",
            storageBucket: "code-breaker-duel.appspot.com",
            messagingSenderId: "165393867049",
            appId: "1:165393867049:web:2d50c1c9073a38d4b28038",
            measurementId: "G-NDKVEEE4YR"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.appState = {
            username: '',
            userId: 'user_' + Math.random().toString(36).substr(2, 9),
            roomId: null,
            playerNumber: null,
            currentGame: null
        };

        window.goBack = function() {
            document.getElementById('landing-screen').classList.remove('hidden');
            document.getElementById('room-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.add('hidden');
        };

        window.goToRoomSelect = function() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert('Please enter your name');
                return;
            }
            window.appState.username = username;
            document.getElementById('room-username').textContent = username;
            document.getElementById('landing-screen').classList.add('hidden');
            document.getElementById('room-screen').classList.remove('hidden');
        };

        window.createRoom = async function() {
            const roomId = 'R' + Math.random().toString(36).substr(2, 5).toUpperCase();
            window.appState.roomId = roomId;
            window.appState.playerNumber = 'p1';
            
            const roomRef = doc(db, 'rooms', roomId);
            await setDoc(roomRef, {
                id: roomId,
                p1_id: window.appState.userId,
                p1_name: window.appState.username,
                p2_id: null,
                p2_name: null,
                status: 'waiting',
                createdAt: Date.now()
            });

            enterLobby();
        };

        window.joinRoom = async function() {
            const roomCode = document.getElementById('room-code-input').value.toUpperCase();
            if (!roomCode || roomCode.length !== 6) {
                document.getElementById('join-message').textContent = 'Invalid room code';
                return;
            }

            try {
                const roomSnap = await getDocs(query(collection(db, 'rooms'), where('id', '==', roomCode)));
                
                if (roomSnap.empty) {
                    document.getElementById('join-message').textContent = 'Room not found';
                    return;
                }

                const room = roomSnap.docs[0].data();
                const roomRef = roomSnap.docs[0].ref;
                
                if (room.p1_id === window.appState.userId) {
                    window.appState.playerNumber = 'p1';
                } else if (room.p2_id === window.appState.userId) {
                    window.appState.playerNumber = 'p2';
                } else if (room.p2_id === null) {
                    window.appState.playerNumber = 'p2';
                    await updateDoc(roomRef, {
                        p2_id: window.appState.userId,
                        p2_name: window.appState.username,
                        status: 'active'
                    });
                } else {
                    document.getElementById('join-message').textContent = 'Room is full';
                    return;
                }

                window.appState.roomId = roomCode;
                enterLobby();
            } catch (error) {
                console.error('Error joining room:', error);
                document.getElementById('join-message').textContent = 'Error joining room';
            }
        };

        window.enterLobby = function() {
            document.getElementById('room-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
            document.getElementById('lobby-room-id').textContent = window.appState.roomId;
            document.getElementById('lobby-your-name').textContent = window.appState.username;
            
            listenToRoom();
        };

        window.listenToRoom = function() {
            const roomRef = doc(db, 'rooms', window.appState.roomId);
            onSnapshot(roomRef, (doc) => {
                if (doc.exists()) {
                    const room = doc.data();
                    const opponentName = window.appState.playerNumber === 'p1' ? room.p2_name : room.p1_name;
                    document.getElementById('lobby-opponent-name').textContent = opponentName || 'Waiting...';
                }
            });
        };

        window.selectGame = function(gameType) {
            window.appState.currentGame = gameType;
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-container').classList.remove('hidden');
            loadGame(gameType);
        };

        window.exitRoom = async function() {
            if (confirm('Are you sure you want to exit this room?')) {
                try {
                    const roomRef = doc(db, 'rooms', window.appState.roomId);
                    await deleteDoc(roomRef);
                    window.appState.roomId = null;
                    window.appState.playerNumber = null;
                    document.getElementById('lobby-screen').classList.add('hidden');
                    document.getElementById('game-container').classList.add('hidden');
                    document.getElementById('landing-screen').classList.remove('hidden');
                } catch (error) {
                    console.error('Error exiting room:', error);
                }
            }
        };

        window.backToLobby = async function() {
            document.getElementById('game-container').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
        };

        window.loadGame = function(gameType) {
            switch(gameType) {
                case 'codebreaker':
                    loadCodeBreakerGame();
                    break;
                case 'tictactoe':
                    loadTicTacToeGame();
                    break;
                case 'wavelength':
                    loadWavelengthGame();
                    break;
                case 'stonepaper':
                    loadStonePaperGame();
                    break;
                case 'fastfour':
                    loadFastFourGame();
                    break;
            }
        };

        // ==================== CODE BREAKER GAME ====================
        window.loadCodeBreakerGame = function() {
            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div class="max-w-4xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-indigo-600">üîê Code Breaker</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="cb-status" class="bg-indigo-100 text-indigo-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading...</div>

                    <div id="cb-setup" class="mb-8">
                        <h3 class="text-2xl font-bold text-gray-800 mb-4">Enter Your Secret 4-Digit Code</h3>
                        <div class="flex gap-3 mb-4">
                            <input type="text" id="cb-code-input" maxlength="4" class="flex-grow p-3 border-2 border-gray-300 rounded-lg text-3xl tracking-widest text-center font-mono focus:border-indigo-500" placeholder="1234">
                            <button onclick="cbSetCode()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg">Lock In</button>
                        </div>
                        <p id="cb-message" class="text-red-500 h-5"></p>
                    </div>

                    <div id="cb-gameplay" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-indigo-50 p-6 rounded-lg border-2 border-indigo-300">
                                <h4 class="font-bold text-lg mb-4">Make Your Guess</h4>
                                <div class="flex gap-3 mb-4">
                                    <input type="text" id="cb-guess" maxlength="4" class="flex-grow p-3 border-2 border-gray-300 rounded-lg text-2xl tracking-widest text-center font-mono">
                                    <button onclick="cbSubmitGuess()" id="cb-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50" disabled>Submit</button>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold text-lg mb-4">History</h4>
                                <div class="max-h-80 overflow-y-auto bg-gray-50 rounded-lg p-4">
                                    <table class="w-full text-sm"><tbody id="cb-history"></tbody></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            window.cbState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                secret: null,
                maxTurns: 10,
                myGuesses: [],
                oppGuesses: [],
                myTurns: 0,
                oppTurns: 0,
                gameEnded: false
            };

            cbInitialize();
        };

        window.cbInitialize = async function() {
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'cbgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    p1_secret: null,
                    p2_secret: null,
                    p1_guesses: [],
                    p2_guesses: [],
                    turn: 'p1',
                    status: 'setup',
                    createdAt: Date.now()
                });
            }
            
            cbListen();
        };

        window.cbListen = function() {
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                const opp = window.cbState.playerNum === 'p1' ? 'p2' : 'p1';
                
                if (!game[`${window.cbState.playerNum}_secret`]) {
                    document.getElementById('cb-setup').classList.remove('hidden');
                    document.getElementById('cb-gameplay').classList.add('hidden');
                    document.getElementById('cb-status').textContent = 'Enter your secret code';
                    return;
                }
                
                if (!game[`${opp}_secret`]) {
                    document.getElementById('cb-status').textContent = 'Waiting for opponent...';
                    return;
                }
                
                document.getElementById('cb-setup').classList.add('hidden');
                document.getElementById('cb-gameplay').classList.remove('hidden');
                
                window.cbState.myGuesses = game[`${window.cbState.playerNum}_guesses`] || [];
                window.cbState.oppGuesses = game[`${opp}_guesses`] || [];
                window.cbState.myTurns = window.cbState.myGuesses.length;
                window.cbState.oppTurns = window.cbState.oppGuesses.length;
                
                const isMyTurn = game.turn === window.cbState.playerNum;
                document.getElementById('cb-btn').disabled = !isMyTurn;
                document.getElementById('cb-status').textContent = isMyTurn ? `Your Turn (${window.cbState.myTurns}/${window.cbState.maxTurns})` : `Opponent's Turn (${window.cbState.oppTurns}/${window.cbState.maxTurns})`;
                
                cbRenderHistory();
                
                if (game.status && (game.status.includes('_won') || game.status === 'draw')) {
                    cbShowEnd(game, game[`${opp}_secret`]);
                }
            });
        };

        window.cbSetCode = async function() {
            const code = document.getElementById('cb-code-input').value;
            if (code.length !== 4 || !/^\d{4}$/.test(code) || new Set(code).size !== 4) {
                document.getElementById('cb-message').textContent = 'Must be 4 unique digits';
                return;
            }
            
            window.cbState.secret = code;
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            const update = {};
            update[`${window.cbState.playerNum}_secret`] = code;
            await updateDoc(gameRef, update);
            
            document.getElementById('cb-code-input').disabled = true;
        };

        window.cbSubmitGuess = async function() {
            const guess = document.getElementById('cb-guess').value;
            if (guess.length !== 4 || !/^\d{4}$/.test(guess) || new Set(guess).size !== 4) return;
            if (window.cbState.myTurns >= window.cbState.maxTurns) return;
            
            const gameSnap = await getDocs(query(collection(db, 'cbgames'), where('roomId', '==', window.appState.roomId)));
            const game = gameSnap.docs[0].data();
            const opp = window.cbState.playerNum === 'p1' ? 'p2' : 'p1';
            const oppSecret = game[`${opp}_secret`];
            
            const {bulls, cows} = cbCalcFeedback(guess, oppSecret);
            const newGuess = {guess, bulls, cows, timestamp: Date.now()};
            
            let status = 'active';
            if (bulls === 4) status = `${window.cbState.playerNum}_won`;
            else if (window.cbState.myTurns + 1 >= window.cbState.maxTurns && window.cbState.oppTurns >= window.cbState.maxTurns) {
                const oppWon = game[`${opp}_guesses`].some(g => g.bulls === 4);
                if (!oppWon) status = 'draw';
            }
            
            const gameRef = doc(db, 'cbgames', window.appState.roomId);
            await updateDoc(gameRef, {
                [`${window.cbState.playerNum}_guesses`]: arrayUnion(newGuess),
                turn: opp,
                status: status
            });
            
            document.getElementById('cb-guess').value = '';
            document.getElementById('cb-btn').disabled = true;
        };

        window.cbCalcFeedback = function(guess, secret) {
            let bulls = 0, cows = 0;
            const sa = secret.split('');
            const ga = guess.split('');
            
            for (let i = 0; i < 4; i++) {
                if (ga[i] === sa[i]) { bulls++; sa[i] = null; ga[i] = null; }
            }
            for (let i = 0; i < 4; i++) {
                if (ga[i] !== null && sa.includes(ga[i])) { cows++; sa[sa.indexOf(ga[i])] = null; }
            }
            return {bulls, cows};
        };

        window.cbRenderHistory = function() {
            const hist = document.getElementById('cb-history');
            hist.innerHTML = window.cbState.myGuesses.map((g, i) => 
                `<tr class="border-t"><td class="p-2">${i+1}</td><td class="p-2 font-mono font-bold">${g.guess}</td><td class="p-2 text-center text-green-600 font-bold">${g.bulls}</td><td class="p-2 text-center text-yellow-600 font-bold">${g.cows}</td></tr>`
            ).join('');
        };

        window.cbShowEnd = function(game, oppSecret) {
            if (window.cbState.gameEnded) return;
            window.cbState.gameEnded = true;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            let title = '', color = '';
            
            if (game.status === `${window.cbState.playerNum}_won`) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
            } else if (game.status === 'draw') {
                title = 'ü§ù DRAW!';
                color = 'text-yellow-600';
            } else {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-4">Opponent's code: <span class="font-mono font-bold">${oppSecret}</span></p>
                <button onclick="backToLobby()" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        // ==================== TIC TAC TOE GAME ====================
        window.loadTicTacToeGame = function() {
            const container = document.getElementById('game-container');
            container.innerHTML = `
                <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-2xl p-8 fade-in">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-3xl font-bold text-green-600">‚≠ï Tic Tac Toe</h2>
                        <button onclick="backToLobby()" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Back</button>
                    </div>
                    
                    <div id="ttt-status" class="bg-green-100 text-green-800 p-4 rounded-lg mb-6 font-semibold text-center">Loading...</div>

                    <!-- Round Info -->
                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="bg-blue-50 p-3 rounded-lg text-center border-2 border-blue-300">
                            <p class="text-sm text-gray-600">Round</p>
                            <p class="text-2xl font-bold text-blue-600" id="ttt-round">1/3</p>
                        </div>
                        <div class="bg-purple-50 p-3 rounded-lg text-center border-2 border-purple-300">
                            <p class="text-sm text-gray-600">Your Wins</p>
                            <p class="text-2xl font-bold text-purple-600" id="ttt-your-wins">0</p>
                        </div>
                        <div class="bg-orange-50 p-3 rounded-lg text-center border-2 border-orange-300">
                            <p class="text-sm text-gray-600">Opponent Wins</p>
                            <p class="text-2xl font-bold text-orange-600" id="ttt-opp-wins">0</p>
                        </div>
                    </div>

                    <!-- Board -->
                    <div class="mb-6">
                        <div class="grid grid-cols-3 gap-2 bg-gray-800 p-2 rounded-lg" id="ttt-board">
                            ${Array(9).fill(0).map((_, i) => 
                                `<button onclick="tttMakeMove(${i})" id="ttt-cell-${i}" class="w-20 h-20 bg-white text-3xl font-bold rounded hover:bg-gray-100 transition text-center"></button>`
                            ).join('')}
                        </div>
                    </div>

                    <!-- Current Player -->
                    <div id="ttt-current" class="text-center text-lg font-semibold text-gray-700 mb-4">Waiting for game start...</div>
                </div>
            `;

            window.tttState = {
                roomId: window.appState.roomId,
                playerId: window.appState.userId,
                playerNum: window.appState.playerNumber,
                playerSymbol: window.appState.playerNumber === 'p1' ? 'X' : 'O',
                currentRound: 1,
                maxRounds: 3,
                yourWins: 0,
                oppWins: 0,
                board: ['', '', '', '', '', '', '', '', ''],
                currentPlayer: 'p1',
                gameEnded: false,
                roundEnded: false,
                gameOverall: false
            };

            tttInitialize();
        };

        window.tttInitialize = async function() {
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            const existing = await getDocs(query(collection(db, 'tttgames'), where('roomId', '==', window.appState.roomId)));
            
            if (existing.empty) {
                await setDoc(gameRef, {
                    roomId: window.appState.roomId,
                    board: ['', '', '', '', '', '', '', '', ''],
                    currentPlayer: 'p1',
                    round: 1,
                    p1_wins: 0,
                    p2_wins: 0,
                    status: 'active',
                    createdAt: Date.now()
                });
            }
            
            tttListen();
        };

        window.tttListen = function() {
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            onSnapshot(gameRef, (doc) => {
                if (!doc.exists()) return;
                const game = doc.data();
                
                window.tttState.board = game.board;
                window.tttState.currentRound = game.round || 1;
                window.tttState.yourWins = window.tttState.playerNum === 'p1' ? (game.p1_wins || 0) : (game.p2_wins || 0);
                window.tttState.oppWins = window.tttState.playerNum === 'p1' ? (game.p2_wins || 0) : (game.p1_wins || 0);
                window.tttState.currentPlayer = game.currentPlayer;
                
                document.getElementById('ttt-round').textContent = `${window.tttState.currentRound}/3`;
                document.getElementById('ttt-your-wins').textContent = window.tttState.yourWins;
                document.getElementById('ttt-opp-wins').textContent = window.tttState.oppWins;
                
                tttRenderBoard();
                
                const winner = tttCheckWinner(window.tttState.board);
                if (winner) {
                    window.tttState.roundEnded = true;
                    if (winner === window.tttState.playerSymbol) {
                        window.tttState.yourWins++;
                        document.getElementById('ttt-status').textContent = '‚úÖ You won this round!';
                    } else {
                        window.tttState.oppWins++;
                        document.getElementById('ttt-status').textContent = '‚ùå Opponent won this round';
                    }
                    
                    if (window.tttState.currentRound < 3) {
                        setTimeout(() => tttStartNewRound(), 2000);
                    } else {
                        tttShowFinalResult();
                    }
                } else if (window.tttState.board.every(cell => cell !== '')) {
                    window.tttState.roundEnded = true;
                    document.getElementById('ttt-status').textContent = 'ü§ù This round is a tie!';
                    
                    if (window.tttState.currentRound < 3) {
                        setTimeout(() => tttStartNewRound(), 2000);
                    } else {
                        tttShowFinalResult();
                    }
                } else {
                    const isMyTurn = game.currentPlayer === window.tttState.playerNum;
                    document.getElementById('ttt-status').classList.toggle('!bg-green-200', isMyTurn);
                    document.getElementById('ttt-status').classList.toggle('!bg-gray-200', !isMyTurn);
                    document.getElementById('ttt-status').textContent = isMyTurn ? 'üéØ Your Turn' : '‚è≥ Opponent\'s Turn';
                    
                    Array.from(document.querySelectorAll('[id^="ttt-cell-"]')).forEach(cell => {
                        cell.disabled = !isMyTurn;
                    });
                }
            });
        };

        window.tttMakeMove = async function(index) {
            if (window.tttState.board[index] !== '' || window.tttState.roundEnded) return;
            if (window.tttState.currentPlayer !== window.tttState.playerNum) return;
            
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            const newBoard = [...window.tttState.board];
            newBoard[index] = window.tttState.playerSymbol;
            
            const nextPlayer = window.tttState.playerNum === 'p1' ? 'p2' : 'p1';
            
            await updateDoc(gameRef, {
                board: newBoard,
                currentPlayer: nextPlayer
            });
        };

        window.tttCheckWinner = function(board) {
            const lines = [
                [0, 1, 2],
                [3, 4, 5],
                [6, 7, 8],
                [0, 3, 6],
                [1, 4, 7],
                [2, 5, 8],
                [0, 4, 8],
                [2, 4, 6]
            ];
            
            for (let line of lines) {
                if (board[line[0]] && board[line[0]] === board[line[1]] && board[line[1]] === board[line[2]]) {
                    return board[line[0]];
                }
            }
            return null;
        };

        window.tttRenderBoard = function() {
            window.tttState.board.forEach((cell, idx) => {
                const cellEl = document.getElementById(`ttt-cell-${idx}`);
                cellEl.textContent = cell;
                cellEl.className = `w-20 h-20 rounded text-3xl font-bold transition text-center ${
                    cell === 'X' ? 'bg-blue-100 text-blue-600' :
                    cell === 'O' ? 'bg-red-100 text-red-600' :
                    'bg-white hover:bg-gray-100'
                }`;
            });
        };

        window.tttStartNewRound = async function() {
            window.tttState.currentRound++;
            window.tttState.roundEnded = false;
            window.tttState.board = ['', '', '', '', '', '', '', '', ''];
            window.tttState.currentPlayer = 'p1';
            
            const gameRef = doc(db, 'tttgames', window.appState.roomId);
            const p1Wins = window.tttState.playerNum === 'p1' ? window.tttState.yourWins : window.tttState.oppWins;
            const p2Wins = window.tttState.playerNum === 'p1' ? window.tttState.oppWins : window.tttState.yourWins;
            
            await updateDoc(gameRef, {
                board: window.tttState.board,
                currentPlayer: 'p1',
                round: window.tttState.currentRound,
                p1_wins: p1Wins,
                p2_wins: p2Wins
            });
        };

        window.tttShowFinalResult = function() {
            window.tttState.gameOverall = true;
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            
            let title = '', color = '', message = '';
            if (window.tttState.yourWins > window.tttState.oppWins) {
                title = 'üéâ YOU WIN!';
                color = 'text-green-600';
                message = `You won ${window.tttState.yourWins} out of 3 rounds!`;
            } else if (window.tttState.oppWins > window.tttState.yourWins) {
                title = 'üò¢ YOU LOSE!';
                color = 'text-red-600';
                message = `Opponent won ${window.tttState.oppWins} out of 3 rounds!`;
            } else {
                title = 'ü§ù DRAW!';
                color = 'text-yellow-600';
                message = `Both won ${window.tttState.yourWins} rounds each!`;
            }
            
            modal.innerHTML = `<div class="bg-white rounded-2xl p-8 max-w-md text-center">
                <h3 class="text-3xl font-bold mb-4 ${color}">${title}</h3>
                <p class="text-gray-700 mb-6">${message}</p>
                <button onclick="backToLobby()" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg">Back to Lobby</button>
            </div>`;
            document.body.appendChild(modal);
        };

        window.loadWavelengthGame = function() {
            alert('Wavelength - Coming Soon!');
        };
        window.loadStonePaperGame = function() {
            alert('Stone Paper Scissor - Coming Soon!');
        };
        window.loadFastFourGame = function() {
            alert('Fast Four - Coming Soon!');
        };
        window.startWar = function() {
            alert('Declare a War - Coming Soon!');
        };

        console.log('Ka re? Platform Ready');
    </script>
</body>
</html>
